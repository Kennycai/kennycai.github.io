<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://kennycai.github.io').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="基本操作安装详见 docker 文档 访问 127.0.0.1:9200 数据格式">
<meta property="og:type" content="article">
<meta property="og:title" content="ES">
<meta property="og:url" content="https://kennycai.github.io/2021/06/10/database/ES/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:description" content="基本操作安装详见 docker 文档 访问 127.0.0.1:9200 数据格式">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E7%B4%A2%E5%BC%95.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C-%E4%BF%AE%E6%94%B9%E5%AD%97%E6%AE%B5.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E5%88%9B%E5%BB%BA%E6%98%A0%E5%B0%84.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%9F%A5%E7%9C%8B%E6%98%A0%E5%B0%84.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E7%B4%A2%E5%BC%95%E6%98%A0%E5%B0%84%E5%85%B3%E8%81%94.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E6%96%87%E6%A1%A3.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E6%96%87%E6%A1%A32.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E5%8C%B9%E9%85%8D%E6%9F%A5%E8%AF%A2.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E5%AD%97%E6%AE%B5%E5%8C%B9%E9%85%8D%E6%9F%A5%E8%AF%A2.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E5%85%B3%E9%94%AE%E5%AD%97%E7%B2%BE%E7%A1%AE%E6%9F%A5%E8%AF%A2.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E5%A4%9A%E5%85%B3%E9%94%AE%E5%AD%97%E7%B2%BE%E7%A1%AE%E6%9F%A5%E8%AF%A2.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%8C%87%E5%AE%9A%E6%9F%A5%E8%AF%A2%E5%AD%97%E6%AE%B5.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E8%BF%87%E6%BB%A4%E5%AD%97%E6%AE%B5.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E7%BB%84%E5%90%88%E6%9F%A5%E8%AF%A2-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C2.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E5%8D%95%E5%AD%97%E6%AE%B5%E6%8E%92%E5%BA%8F-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E5%A4%9A%E5%AD%97%E6%AE%B5%E6%8E%92%E5%BA%8F-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E9%AB%98%E4%BA%AE%E6%9F%A5%E8%AF%A2-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C2.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2-%E6%B1%82%E5%92%8C-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E5%AF%B9%E6%9F%90%E4%B8%AA%E5%AD%97%E6%AE%B5%E7%9A%84%E5%80%BC%E8%BF%9B%E8%A1%8C%E5%8E%BB%E9%87%8D%E4%B9%8B%E5%90%8E%E5%86%8D%E5%8F%96%E6%80%BB%E6%95%B0.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E5%88%86%E7%89%87%E6%8E%A7%E5%88%B6.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%95%B0%E6%8D%AE%E5%86%99%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%95%B0%E6%8D%AE%E8%AF%BB%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B2.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E5%8E%9F%E7%90%86-%E6%AD%A3%E5%90%91%E7%B4%A2%E5%BC%95.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E5%8E%9F%E7%90%86-%E5%8F%8D%E5%90%91%E7%B4%A2%E5%BC%95.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BE%8B%E5%AD%90.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BE%8B%E5%AD%902.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BE%8B%E5%AD%903.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E5%8A%A8%E6%80%81%E6%9B%B4%E6%96%B0%E7%B4%A2%E5%BC%95-%E6%96%B0%E6%96%87%E6%A1%A3%E8%A2%AB%E6%94%B6%E9%9B%86%E5%88%B0%E5%86%85%E5%AD%98%E7%B4%A2%E5%BC%95%E7%BC%93%E5%AD%98.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E5%8A%A8%E6%80%81%E6%9B%B4%E6%96%B0%E7%B4%A2%E5%BC%95-%E5%86%85%E5%AD%98%E7%BC%93%E5%AD%98%E6%B8%85%E7%A9%BA.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E8%BF%91%E5%AE%9E%E6%97%B6%E6%90%9C%E7%B4%A2.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E8%BF%91%E5%AE%9E%E6%97%B6%E6%90%9C%E7%B4%A22.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E8%BF%91%E5%AE%9E%E6%97%B6%E6%90%9C%E7%B4%A23.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%8C%81%E4%B9%85%E5%8C%96%E5%8F%98%E6%9B%B4.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%8C%81%E4%B9%85%E5%8C%96%E5%8F%98%E6%9B%B42.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%8C%81%E4%B9%85%E5%8C%96%E5%8F%98%E6%9B%B43.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%8C%81%E4%B9%85%E5%8C%96%E5%8F%98%E6%9B%B44.png">
<meta property="og:image" content="https://kennycai.github.io/images/database/es/%E6%AE%B5%E5%90%88%E5%B9%B6.png">
<meta property="article:published_time" content="2021-06-10T12:00:00.000Z">
<meta property="article:modified_time" content="2025-10-07T15:15:47.907Z">
<meta property="article:author" content="Cai Kenny">
<meta property="article:tag" content="ES">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kennycai.github.io/images/database/es/%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F.png">

<link rel="canonical" href="https://kennycai.github.io/2021/06/10/database/ES/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>ES | Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://kennycai.github.io/2021/06/10/database/ES/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cai Kenny">
      <meta itemprop="description" content="A Programmer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ES
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-10 12:00:00" itemprop="dateCreated datePublished" datetime="2021-06-10T12:00:00+00:00">2021-06-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-10-07 15:15:47" itemprop="dateModified" datetime="2025-10-07T15:15:47+00:00">2025-10-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/database/" itemprop="url" rel="index">
                    <span itemprop="name">database</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>详见 docker 文档</p>
<p>访问 <a href="http://127.0.0.1:9200/" target="_blank" rel="noopener">127.0.0.1:9200</a></p>
<h2 id="数据格式"><a href="#数据格式" class="headerlink" title="数据格式"></a>数据格式</h2><p>Elasticsearch 是面向文档型数据库，一条数据在这里就是一个文档。为了方便大家理解，我们将 Elasticsearch 里存储文档数据和关系型数据库 MySQL 存储数据的概念进行一个类比ES 里的 Index 可以看做一个库，而 Types 相当于表，Documents 则相当于表的行。这里 Types 的概念已经被逐渐弱化，Elasticsearch 6.X 中，一个 index 下已经只能包含一个type，Elasticsearch 7.X 中, Type 的概念已经被删除了。</p>
<p><img src="/images/database/es/%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F.png" alt="数据格式.png"></p>
<h2 id="HTTP-操作"><a href="#HTTP-操作" class="headerlink" title="HTTP 操作"></a><strong>HTTP</strong> 操作</h2><h3 id="索引操作"><a href="#索引操作" class="headerlink" title="索引操作"></a>索引操作</h3><h4 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h4><blockquote>
<p>对比关系型数据库，创建索引就等同于创建数据库</p>
</blockquote>
<p>在 Postman 中，向 ES 服务器发 <strong>PUT</strong> 请求 ：<a href="http://127.0.0.1:9200/shopping" target="_blank" rel="noopener">http://127.0.0.1:9200/shopping</a></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	"acknowledged"【响应结果】: true, # true操作成功</span><br><span class="line">	"shards_acknowledged"【分片结果】: true, # 分片操作成功</span><br><span class="line">	"index"【索引名称】: "shopping"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果重复添加索引，会返回错误信息</p>
<p>注意：创建索引库的分片数默认 1片，在 7.0.0之前的 Elasticsearch版本中，默认 5片</p>
</blockquote>
<h4 id="查看所有索引"><a href="#查看所有索引" class="headerlink" title="查看所有索引"></a>查看所有索引</h4><p>在 Postman 中，向 ES 服务器发 <strong>GET</strong> 请求 ：<a href="http://127.0.0.1:9200/_cat/indices?v" target="_blank" rel="noopener">http://127.0.0.1:9200/_cat/indices?v</a></p>
<p><img src="/images/database/es/%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E7%B4%A2%E5%BC%95.png" alt="查看所有索引.png"></p>
<table>
<thead>
<tr>
<th>表头</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>health</td>
<td>当前服务器健康状态：<strong>green</strong>(集群完整) <strong>yellow</strong>(单点正常、集群不完整) red(单点不正常)</td>
</tr>
<tr>
<td>status</td>
<td>索引打开、关闭状态</td>
</tr>
<tr>
<td>index</td>
<td>索引名</td>
</tr>
<tr>
<td>uuid</td>
<td>索引统一编号</td>
</tr>
<tr>
<td>pri</td>
<td>主分片数量</td>
</tr>
<tr>
<td>rep</td>
<td>副本数量</td>
</tr>
<tr>
<td>docs.count</td>
<td>可用文档数量</td>
</tr>
<tr>
<td>docs.deleted</td>
<td>文档删除状态（逻辑删除）</td>
</tr>
<tr>
<td>store.size</td>
<td>主分片和副分片整体占空间大小</td>
</tr>
<tr>
<td>pri.store.size</td>
<td>主分片占空间大小</td>
</tr>
</tbody></table>
<h4 id="查看单个索引"><a href="#查看单个索引" class="headerlink" title="查看单个索引"></a>查看单个索引</h4><p>在 Postman 中，向 ES 服务器发 <strong>GET</strong> 请求 :<a href="http://127.0.0.1:9200/shopping" target="_blank" rel="noopener">http://127.0.0.1:9200/shopping</a></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	"shopping"【索引名】: &#123;</span><br><span class="line">		"aliases"【别名】: &#123;&#125;,</span><br><span class="line">		"mappings"【映射】: &#123;&#125;,</span><br><span class="line">		"settings"【设置】: &#123;</span><br><span class="line">			"index"【设置 - 索引】: &#123;</span><br><span class="line">				"creation_date"【设置 - 索引 - 创建时间】: "1614265373911",</span><br><span class="line">				"number_of_shards"【设置 - 索引 - 主分片数量】: "1",</span><br><span class="line">				"number_of_replicas"【设置 - 索引 - 副分片数量】: "1",</span><br><span class="line">				"uuid"【设置 - 索引 - 唯一标识】: "eI5wemRERTumxGCc1bAk2A",</span><br><span class="line">				"version"【设置 - 索引 - 版本】: &#123;</span><br><span class="line">					"created": "7080099"</span><br><span class="line">				&#125;,</span><br><span class="line">				"provided_name"【设置 - 索引 - 名称】: "shopping"</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h4><p>在 Postman 中，向 ES 服务器发 <strong>DELETE</strong> 请求 <a href="http://127.0.0.1:9200/_cat/indices?v" target="_blank" rel="noopener">：</a><a href="http://127.0.0.1:9200/_cat/indices?v" target="_blank" rel="noopener">http://127.0.0.1:9200/sho</a>pping</p>
<p><img src="/images/database/es/%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95.png" alt="删除索引.png"></p>
<h3 id="文档操作"><a href="#文档操作" class="headerlink" title="文档操作"></a>文档操作</h3><h4 id="创建文档"><a href="#创建文档" class="headerlink" title="创建文档"></a>创建文档</h4><p>在 Postman 中，向 ES 服务器发 <strong>POST</strong> 请求 <a href="http://127.0.0.1:9200/_cat/indices?v" target="_blank" rel="noopener">：</a><a href="http://127.0.0.1:9200/_cat/indices?v" target="_blank" rel="noopener">http://127.0.0.1:9200/shop</a>ping<strong>/_doc</strong></p>
<p>请求体内容为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"title"</span>:<span class="string">"小米手机"</span>,</span><br><span class="line">	<span class="attr">"category"</span>:<span class="string">"小米"</span>,</span><br><span class="line">	<span class="attr">"images"</span>:<span class="string">"http://www.gulixueyuan.com/xm.jpg"</span>,</span><br><span class="line">	<span class="attr">"price"</span>:<span class="number">3999.00</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	"_index"【索引】: "shopping",</span><br><span class="line">	"_type"【类型-文档】: "_doc",</span><br><span class="line">	"_id"【唯一标识】: "Xhsa2ncBlvF_7lxyCE9G", #可以类比为 MySQL中的主键，随机生成</span><br><span class="line">	"_version"【版本】: 1,</span><br><span class="line">	"result"【结果】: "created", #这里的 create表示创建成功</span><br><span class="line">	"_shards"【分片】: &#123;</span><br><span class="line">		"total"【分片 - 总数】: 2,</span><br><span class="line">		"successful"【分片 - 成功】: 1,</span><br><span class="line">		"failed"【分片 - 失败】: 0</span><br><span class="line">	&#125;,</span><br><span class="line">	"_seq_no": 0,</span><br><span class="line">	"_primary_term": 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的数据创建后，由于没有指定数据唯一性标识（ID），默认情况下，ES 服务器会随机生成一个。</p>
<p>如果想要自定义唯一性标识，需要在创建时指定：<a href="http://127.0.0.1:9200/shopping/_doc/1" target="_blank" rel="noopener">http://127.0.0.1:9200/shopping/_doc/1</a></p>
<h4 id="查看文档"><a href="#查看文档" class="headerlink" title="查看文档"></a>查看文档</h4><p>查看文档时，需要指明文档的唯一性标识，类似于 MySQL 中数据的主键查询</p>
<p>在 Postman 中，向 ES 服务器发 <strong>GET</strong> 请求 ：<a href="http://127.0.0.1:9200/shopping/_doc/1" target="_blank" rel="noopener">http://127.0.0.1:9200/shopping/_doc/1</a></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	"_index"【索引】: "shopping",</span><br><span class="line">	"_type"【文档类型】: "_doc",</span><br><span class="line">	"_id": "1",</span><br><span class="line">	"_version": 2,</span><br><span class="line">	"_seq_no": 2,</span><br><span class="line">	"_primary_term": 2,</span><br><span class="line">	"found"【查询结果】: true, # true表示查找到，false表示未查找到</span><br><span class="line">	"_source"【文档源信息】: &#123;</span><br><span class="line">		"title": "华为手机",</span><br><span class="line">		"category": "华为",</span><br><span class="line">		"images": "http://www.gulixueyuan.com/hw.jpg",</span><br><span class="line">		"price": 4999.00</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="修改文档"><a href="#修改文档" class="headerlink" title="修改文档"></a>修改文档</h4><p>和新增文档一样，输入相同的 URL 地址请求，如果请求体变化，会将原有的数据内容覆盖在 Postman 中，向 ES 服务器发 <strong>POST</strong> 请求 ：<a href="http://127.0.0.1:9200/shopping/_doc/1" target="_blank" rel="noopener">http://127.0.0.1:9200/shopping/_doc/1</a></p>
<p>请求体内容为:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"title"</span>:<span class="string">"华为手机"</span>,</span><br><span class="line">	<span class="attr">"category"</span>:<span class="string">"华为"</span>,</span><br><span class="line">	<span class="attr">"images"</span>:<span class="string">"http://www.gulixueyuan.com/hw.jpg"</span>,</span><br><span class="line">	<span class="attr">"price"</span>:<span class="number">4999.00</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"_index"</span>: <span class="string">"shopping"</span>,</span><br><span class="line">	<span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">	<span class="attr">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">	"_version"【版本】: 2,</span><br><span class="line">	"result"【结果】: "updated", # updated表示数据被更新</span><br><span class="line">	"_shards": &#123;</span><br><span class="line">		"total": 2,</span><br><span class="line">		"successful": 1,</span><br><span class="line">		"failed": 0</span><br><span class="line">	&#125;,</span><br><span class="line">	"_seq_no": 2,</span><br><span class="line">	"_primary_term": 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="修改字段"><a href="#修改字段" class="headerlink" title="修改字段"></a>修改字段</h4><p>修改数据时，也可以只修改某一给条数据的局部信息</p>
<p>在 Postman 中，向 ES 服务器发 <strong>POST</strong> 请求 ：<a href="http://127.0.0.1:9200/shopping/**_update/1" target="_blank" rel="noopener">http://127.0.0.1:9200/shopping/**_update/1</a>**</p>
<p>请求体内容为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"doc"</span>: &#123;</span><br><span class="line">		<span class="attr">"price"</span>:<span class="number">3000.00</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改成功后，服务器响应结果：</p>
<p><img src="/images/database/es/%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C-%E4%BF%AE%E6%94%B9%E5%AD%97%E6%AE%B5.png" alt="文档操作-修改字段.png"></p>
<h4 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h4><p>删除一个文档不会立即从磁盘上移除，它只是被标记成已删除（逻辑删除）。</p>
<p>在 Postman 中，向 ES 服务器发 <strong>DELETE</strong> 请求 ：<a href="http://127.0.0.1:9200/shopping**/_doc/1" target="_blank" rel="noopener">http://127.0.0.1:9200/shopping**/_doc/1</a>**</p>
<p>删除成功，服务器响应结果：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"_index"</span>: <span class="string">"shopping"</span>,</span><br><span class="line">	<span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">	<span class="attr">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">	"_version"【版本】: 4, #对数据的操作，都会更新版本</span><br><span class="line">	"result"【结果】: "deleted", # deleted表示数据被标记为删除</span><br><span class="line">	"_shards": &#123;</span><br><span class="line">		"total": 2,</span><br><span class="line">		"successful": 1,</span><br><span class="line">		"failed": 0</span><br><span class="line">	&#125;,</span><br><span class="line">	"_seq_no": 4,</span><br><span class="line">	"_primary_term": 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果删除一个并不存在的文档</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"_index"</span>: <span class="string">"shopping"</span>,</span><br><span class="line">	<span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">	<span class="attr">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">	<span class="attr">"_version"</span>: <span class="number">1</span>,</span><br><span class="line">	"result"【结果】: "not_found", # not_found表示未查找到</span><br><span class="line">	"_shards": &#123;</span><br><span class="line">		"total": 2,</span><br><span class="line">		"successful": 1,</span><br><span class="line">		"failed": 0</span><br><span class="line">	&#125;,</span><br><span class="line">	"_seq_no": 5,</span><br><span class="line">	"_primary_term": 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="条件删除文档"><a href="#条件删除文档" class="headerlink" title="条件删除文档"></a>条件删除文档</h4><p>一般删除数据都是根据文档的唯一性标识进行删除，实际操作时，也可以根据条件对多条数据进行删除</p>
<p>向 ES 服务器发 <strong>POST</strong> 请求 ：<a href="http://127.0.0.1:9200/shopping/_delete_by_query" target="_blank" rel="noopener">http://127.0.0.1:9200/shopping/_delete_by_query</a></p>
<p>请求体内容为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"query"</span>:&#123;</span><br><span class="line">		<span class="attr">"match"</span>:&#123;</span><br><span class="line">			<span class="attr">"price"</span>:<span class="number">4000.00</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删除成功后，服务器响应结果：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	"took"【耗时】: 175,</span><br><span class="line">	"timed_out"【是否超时】: false,</span><br><span class="line">	"total"【总数】: 2,</span><br><span class="line">	"deleted"【删除数量】: 2,</span><br><span class="line">	"batches": 1,</span><br><span class="line">	"version_conflicts": 0,</span><br><span class="line">	"noops": 0,</span><br><span class="line">	"retries": &#123;</span><br><span class="line">		"bulk": 0,</span><br><span class="line">		"search": 0</span><br><span class="line">	&#125;,</span><br><span class="line">	"throttled_millis": 0,</span><br><span class="line">	"requests_per_second": -1.0,</span><br><span class="line">	"throttled_until_millis": 0,</span><br><span class="line">	"failures": []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="映射操作"><a href="#映射操作" class="headerlink" title="映射操作"></a>映射操作</h3><p>有了索引库，等于有了数据库中的 database。</p>
<p>接下来就需要建索引库(index)中的映射了，类似于数据库(database)中的表结构(table)。创建数据库表需要设置字段名称，类型，长度，约束等；索引库也一样，需要知道这个类型下有哪些字段，每个字段有哪些约束信息，这就叫做映射(mapping)</p>
<h3 id="创建映射"><a href="#创建映射" class="headerlink" title="创建映射"></a>创建映射</h3><p>在 Postman 中，向 ES 服务器发 <strong>PUT</strong> 请求 ：<a href="http://127.0.0.1:9200/student/_mapping" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_mapping</a></p>
<p>请求体内容为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"properties"</span>: &#123;</span><br><span class="line">		<span class="attr">"name"</span>:&#123;</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">			<span class="attr">"index"</span>: <span class="literal">true</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">"sex"</span>:&#123;</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">			<span class="attr">"index"</span>: <span class="literal">false</span></span><br><span class="line">		&#125;,</span><br><span class="line">    	<span class="attr">"age"</span>:&#123;</span><br><span class="line">			<span class="attr">"type"</span>: <span class="string">"long"</span>,</span><br><span class="line">            <span class="attr">"index"</span>: <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果如下：</p>
<p><img src="/images/database/es/%E5%88%9B%E5%BB%BA%E6%98%A0%E5%B0%84.png" alt="创建映射.png"></p>
<p>映射数据说明：</p>
<ul>
<li><p>字段名：任意填写，下面指定许多属性，例如：title、subtitle、images、price</p>
</li>
<li><p>type：类型，Elasticsearch 中支持的数据类型非常丰富，说几个关键的：</p>
<ul>
<li><p>String 类型，又分两种：</p>
<ul>
<li><p>text：可分词</p>
</li>
<li><p>keyword：不可分词，数据会作为完整字段进行匹配</p>
</li>
</ul>
</li>
<li><p>Numerical：数值类型，分两类</p>
<p>基本数据类型：long、integer、short、byte、double、float、half_float</p>
<p>浮点数的高精度类型：scaled_float</p>
</li>
<li><p>Date：日期类型</p>
</li>
<li><p>Array：数组类型</p>
</li>
<li><p>Object：对象</p>
</li>
<li><p>index：是否索引，默认为 true，也就是说你不进行任何配置，所有字段都会被索引。</p>
<ul>
<li><p>true：字段会被索引，则可以用来进行搜索</p>
</li>
<li><p>false：字段不会被索引，不能用来搜索</p>
</li>
</ul>
</li>
<li><p>store：是否将数据进行独立存储，默认为 false</p>
</li>
</ul>
<p>原始的文本会存储在_source 里面，默认情况下其他提取出来的字段都不是独立存储的，是从_source 里面提取出来的。当然你也可以独立的存储某个字段，只要设置”store”: true 即可，获取独立存储的字段要比从_source 中解析快得多，但是也会占用更多的空间，所以要根据实际业务需求来设置。</p>
<ul>
<li>analyzer：分词器，这里的 ik_max_word 即使用 ik 分词器,后面会有专门的章节学习</li>
</ul>
</li>
</ul>
<h4 id="查看映射"><a href="#查看映射" class="headerlink" title="查看映射"></a>查看映射</h4><p>在 Postman 中，向 ES 服务器发 <strong>GET</strong> 请求 ：<a href="http://127.0.0.1:9200/student**/_mapping" target="_blank" rel="noopener">http://127.0.0.1:9200/student**/_mapping</a>**</p>
<p>服务器响应结果如下：</p>
<p><img src="/images/database/es/%E6%9F%A5%E7%9C%8B%E6%98%A0%E5%B0%84.png" alt="查看映射.png"></p>
<h4 id="索引映射关联"><a href="#索引映射关联" class="headerlink" title="索引映射关联"></a>索引映射关联</h4><p>在 Postman 中，向 ES 服务器发 <strong>PUT</strong> 请求 ：<a href="http://127.0.0.1:9200/student1" target="_blank" rel="noopener">http://127.0.0.1:9200/student1</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"settings"</span>: &#123;&#125;,</span><br><span class="line">	<span class="attr">"mappings"</span>: &#123;</span><br><span class="line">		<span class="attr">"properties"</span>: &#123;</span><br><span class="line">			<span class="attr">"name"</span>:&#123;</span><br><span class="line">				<span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">				<span class="attr">"index"</span>: <span class="literal">true</span></span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">"sex"</span>:&#123;</span><br><span class="line">				<span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">				<span class="attr">"index"</span>: <span class="literal">false</span></span><br><span class="line">			&#125;,</span><br><span class="line">            <span class="attr">"age"</span>:&#123;</span><br><span class="line">				<span class="attr">"type"</span>: <span class="string">"long"</span>,</span><br><span class="line">				<span class="attr">"index"</span>: <span class="literal">false</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果如下：</p>
<p><img src="/images/database/es/%E7%B4%A2%E5%BC%95%E6%98%A0%E5%B0%84%E5%85%B3%E8%81%94.png" alt="索引映射关联.png"></p>
<h3 id="高级查询"><a href="#高级查询" class="headerlink" title="高级查询"></a>高级查询</h3><p>Elasticsearch 提供了基于 JSON 提供完整的查询 DSL 来定义查询</p>
<h4 id="查询所有文档"><a href="#查询所有文档" class="headerlink" title="查询所有文档"></a>查询所有文档</h4><p>在 Postman 中，向 ES 服务器发 <strong>GET</strong> 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"query"</span>: &#123;</span><br><span class="line">		<span class="attr">"match_all"</span>: &#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"># "query"：这里的 query代表一个查询对象，里面可以有不同的查询属性</span><br><span class="line"># "match_all"：查询类型，例如：match_all(代表查询所有)， match，term ， range 等等</span><br><span class="line"># &#123;查询条件&#125;：查询条件会根据类型的不同，写法也有差异</span><br></pre></td></tr></table></figure>

<p>服务器响应结果如下：</p>
<p><img src="/images/database/es/%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E6%96%87%E6%A1%A3.png" alt="查询所有文档.png"></p>
<p><img src="/images/database/es/%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E6%96%87%E6%A1%A32.png" alt="查询所有文档2.png"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"took【查询花费时间，单位毫秒】"</span> : <span class="number">1116</span>,</span><br><span class="line">	<span class="attr">"timed_out【是否超时】"</span> : <span class="literal">false</span>,</span><br><span class="line">	<span class="attr">"_shards【分片信息】"</span> : &#123;</span><br><span class="line">		<span class="attr">"total【总数】"</span> : <span class="number">1</span>,</span><br><span class="line">		<span class="attr">"successful【成功】"</span> : <span class="number">1</span>,</span><br><span class="line">		<span class="attr">"skipped【忽略】"</span> : <span class="number">0</span>,</span><br><span class="line">		<span class="attr">"failed【失败】"</span> : <span class="number">0</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"hits【搜索命中结果】"</span> : &#123;</span><br><span class="line">		"total"【搜索条件匹配的文档总数】: &#123;</span><br><span class="line">			"value"【总命中计数的值】: 3,</span><br><span class="line">			"relation"【计数规则】: "eq" # eq 表示计数准确， gte表示计数不准确</span><br><span class="line">	&#125;,</span><br><span class="line">		"max_score【匹配度分值】" : 1.0,</span><br><span class="line">		"hits【命中结果集合】" : [</span><br><span class="line">		]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="匹配查询"><a href="#匹配查询" class="headerlink" title="匹配查询"></a>匹配查询</h4><p>match 匹配类型查询，会把查询条件进行分词，然后进行查询，多个词条之间是 or 的关系在 Postman 中，向 ES 服务器发 GET 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"query"</span>: &#123;</span><br><span class="line">		<span class="attr">"match"</span>: &#123;</span><br><span class="line">			<span class="attr">"name"</span>:<span class="string">"zhangsan"</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果为：</p>
<p><img src="/images/database/es/%E5%8C%B9%E9%85%8D%E6%9F%A5%E8%AF%A2.png" alt="匹配查询.png"></p>
<h4 id="字段匹配查询"><a href="#字段匹配查询" class="headerlink" title="字段匹配查询"></a>字段匹配查询</h4><p>multi_match 与 match 类似，不同的是它可以在多个字段中查询。</p>
<p>在 Postman 中，向 ES 服务器发 GET 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"query"</span>: &#123;</span><br><span class="line">		<span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">			<span class="attr">"query"</span>: <span class="string">"zhangsan"</span>,</span><br><span class="line">			<span class="attr">"fields"</span>: [<span class="string">"name"</span>,<span class="string">"nickname"</span>]</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p><img src="/images/database/es/%E5%AD%97%E6%AE%B5%E5%8C%B9%E9%85%8D%E6%9F%A5%E8%AF%A2.png" alt="字段匹配查询.png"></p>
<h4 id="关键字精确查询"><a href="#关键字精确查询" class="headerlink" title="关键字精确查询"></a>关键字精确查询</h4><p>term 查询，精确的关键词匹配查询，不对查询条件进行分词。</p>
<p>在 Postman 中，向 ES 服务器发 GET 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"query"</span>: &#123;</span><br><span class="line">		<span class="attr">"term"</span>: &#123;</span><br><span class="line">			<span class="attr">"name"</span>: &#123;</span><br><span class="line">				<span class="attr">"value"</span>: <span class="string">"zhangsan"</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p><img src="/images/database/es/%E5%85%B3%E9%94%AE%E5%AD%97%E7%B2%BE%E7%A1%AE%E6%9F%A5%E8%AF%A2.png" alt="关键字精确查询.png"></p>
<h4 id="多关键字精确查询"><a href="#多关键字精确查询" class="headerlink" title="多关键字精确查询"></a>多关键字精确查询</h4><p>terms 查询和 term 查询一样，但它允许你指定多值进行匹配。</p>
<p>如果这个字段包含了指定值中的任何一个值，那么这个文档满足条件，类似于 mysql 的 in在 Postman 中，向 ES 服务器发 GET 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"query"</span>: &#123;</span><br><span class="line">		<span class="attr">"terms"</span>: &#123;</span><br><span class="line">			<span class="attr">"name"</span>: [<span class="string">"zhangsan"</span>,<span class="string">"lisi"</span>]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p><img src="/images/database/es/%E5%A4%9A%E5%85%B3%E9%94%AE%E5%AD%97%E7%B2%BE%E7%A1%AE%E6%9F%A5%E8%AF%A2.png" alt="多关键字精确查询.png"></p>
<h4 id="指定查询字段"><a href="#指定查询字段" class="headerlink" title="指定查询字段"></a>指定查询字段</h4><p>默认情况下，Elasticsearch 在搜索的结果中，会把文档中保存在_source 的所有字段都返回。如果我们只想获取其中的部分字段，我们可以添加_source 的过滤</p>
<p>在 Postman 中，向 ES 服务器发 GET 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"_source"</span>: [<span class="string">"name"</span>,<span class="string">"nickname"</span>],</span><br><span class="line">	<span class="attr">"query"</span>: &#123;</span><br><span class="line">		<span class="attr">"terms"</span>: &#123;</span><br><span class="line">			<span class="attr">"nickname"</span>: [<span class="string">"zhangsan"</span>]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p><img src="/images/database/es/%E6%8C%87%E5%AE%9A%E6%9F%A5%E8%AF%A2%E5%AD%97%E6%AE%B5.png" alt="指定查询字段.png"></p>
<h4 id="过滤字段"><a href="#过滤字段" class="headerlink" title="过滤字段"></a>过滤字段</h4><p>我们也可以通过：</p>
<p>​    includes：来指定想要显示的字段</p>
<p>​    excludes：来指定不想要显示的字段</p>
<p>在 Postman 中，向 ES 服务器发 GET 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"_source"</span>: &#123;</span><br><span class="line">		<span class="attr">"includes"</span>: [<span class="string">"name"</span>,<span class="string">"nickname"</span>]</span><br><span class="line">	&#125;,</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">		<span class="attr">"terms"</span>: &#123;</span><br><span class="line">			<span class="attr">"nickname"</span>: [<span class="string">"zhangsan"</span>]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p><img src="/images/database/es/%E8%BF%87%E6%BB%A4%E5%AD%97%E6%AE%B5.png" alt="过滤字段.png"></p>
<h4 id="组合查询"><a href="#组合查询" class="headerlink" title="组合查询"></a>组合查询</h4><p><code>bool</code>把各种其它查询通过<code>must</code>（必须 ）、<code>must_not</code>（必须不）、<code>should</code>（应该）的方式进行组合</p>
<p>在 Postman 中，向 ES 服务器发 <strong>GET</strong> 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"query"</span>: &#123;</span><br><span class="line">		<span class="attr">"bool"</span>: &#123;</span><br><span class="line">			<span class="attr">"must"</span>: [</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"match"</span>: &#123;</span><br><span class="line">					<span class="attr">"name"</span>: <span class="string">"zhangsan"</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			],</span><br><span class="line">			<span class="attr">"must_not"</span>: [</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"match"</span>: &#123;</span><br><span class="line">					<span class="attr">"age"</span>: <span class="string">"40"</span></span><br><span class="line">                    &#125;</span><br><span class="line">				&#125;</span><br><span class="line">			],</span><br><span class="line">			<span class="attr">"should"</span>: [</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"match"</span>: &#123;</span><br><span class="line">					<span class="attr">"sex"</span>: <span class="string">"男"</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">            ]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p><img src="/images/database/es/%E7%BB%84%E5%90%88%E6%9F%A5%E8%AF%A2-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C.png" alt="组合查询-响应结果.png"></p>
<h4 id="范围查询"><a href="#范围查询" class="headerlink" title="范围查询"></a>范围查询</h4><table>
<thead>
<tr>
<th>操作符</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>gt</td>
<td>大于&gt;</td>
</tr>
<tr>
<td>gte</td>
<td>大于等于&gt;=</td>
</tr>
<tr>
<td>lt</td>
<td>小于&lt;</td>
</tr>
<tr>
<td>lte</td>
<td>小于等于&lt;=</td>
</tr>
</tbody></table>
<p>在 Postman 中，向 ES 服务器发 <strong>GET</strong> 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"query"</span>: &#123;</span><br><span class="line">		<span class="attr">"range"</span>: &#123;</span><br><span class="line">			<span class="attr">"age"</span>: &#123;</span><br><span class="line">				<span class="attr">"gte"</span>: <span class="number">30</span>,</span><br><span class="line">				<span class="attr">"lte"</span>: <span class="number">35</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p><img src="/images/database/es/%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C.png" alt="范围查询-响应结果.png"></p>
<h4 id="模糊查询"><a href="#模糊查询" class="headerlink" title="模糊查询"></a>模糊查询</h4><p>返回包含与搜索字词相似的字词的文档。</p>
<p>编辑距离是将一个术语转换为另一个术语所需的一个字符更改的次数。这些更改可以包括：</p>
<ul>
<li><p>更改字符（box → fox）</p>
</li>
<li><p>删除字符（black → lack）</p>
</li>
<li><p>插入字符（sic → sick）</p>
</li>
<li><p>转置两个相邻字符（act → cat）</p>
</li>
</ul>
<p>为了找到相似的术语，fuzzy 查询会在指定的编辑距离内创建一组搜索词的所有可能的变体或扩展。然后查询返回每个扩展的完全匹配。</p>
<p>通过 fuzziness 修改编辑距离。一般使用默认值 AUTO，根据术语的长度生成编辑距离。在 Postman 中，向 ES 服务器发 <strong>GET</strong> 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"query"</span>: &#123;</span><br><span class="line">		<span class="attr">"fuzzy"</span>: &#123;</span><br><span class="line">			<span class="attr">"title"</span>: &#123;</span><br><span class="line">				<span class="attr">"value"</span>: <span class="string">"zhangsan"</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p><img src="/images/database/es/%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C.png" alt="模糊查询-响应结果.png"></p>
<p>在 Postman 中，向 ES 服务器发 <strong>GET</strong> 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"query"</span>: &#123;</span><br><span class="line">		<span class="attr">"fuzzy"</span>: &#123;</span><br><span class="line">			<span class="attr">"title"</span>: &#123;</span><br><span class="line">				<span class="attr">"value"</span>: <span class="string">"zhangsan"</span>,</span><br><span class="line">				<span class="attr">"fuzziness"</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p><img src="/images/database/es/%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C2.png" alt="模糊查询-响应结果2.png"></p>
<h4 id="单字段排序"><a href="#单字段排序" class="headerlink" title="单字段排序"></a>单字段排序</h4><p>sort 可以让我们按照不同的字段进行排序，并且通过 order 指定排序的方式。desc 降序，asc升序。</p>
<p>在 Postman 中，向 ES 服务器发 GET 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"query"</span>: &#123;</span><br><span class="line">		<span class="attr">"match"</span>: &#123;</span><br><span class="line">			<span class="attr">"name"</span>:<span class="string">"zhangsan"</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"sort"</span>: [&#123;</span><br><span class="line">		<span class="attr">"age"</span>: &#123;</span><br><span class="line">			<span class="attr">"order"</span>:<span class="string">"desc"</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p><img src="/images/database/es/%E5%8D%95%E5%AD%97%E6%AE%B5%E6%8E%92%E5%BA%8F-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C.png" alt="单字段排序-响应结果.png"></p>
<h4 id="多字段排序"><a href="#多字段排序" class="headerlink" title="多字段排序"></a>多字段排序</h4><p>假定我们想要结合使用 age 和 _score 进行查询，并且匹配的结果首先按照年龄排序，然后按照相关性得分排序</p>
<p>在 Postman 中，向 ES 服务器发 <strong>GET</strong> 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"query"</span>: &#123;</span><br><span class="line">		<span class="attr">"match_all"</span>: &#123;&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"sort"</span>: [</span><br><span class="line">    	&#123;</span><br><span class="line">        	<span class="attr">"age"</span>: &#123;</span><br><span class="line">				<span class="attr">"order"</span>: <span class="string">"desc"</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">"_score"</span>:&#123;</span><br><span class="line">				<span class="attr">"order"</span>: <span class="string">"desc"</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p><img src="/images/database/es/%E5%A4%9A%E5%AD%97%E6%AE%B5%E6%8E%92%E5%BA%8F-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C.png" alt="多字段排序-响应结果.png"></p>
<h4 id="高亮查询"><a href="#高亮查询" class="headerlink" title="高亮查询"></a>高亮查询</h4><p>在进行关键字搜索时，搜索出的内容中的关键字会显示不同的颜色，称之为高亮。</p>
<p>Elasticsearch 可以对查询内容中的关键字部分，进行标签和样式(高亮)的设置。在使用 match 查询的同时，加上一个 highlight 属性：</p>
<ul>
<li><p>pre_tags：前置标签</p>
</li>
<li><p>post_tags：后置标签</p>
</li>
<li><p>fields：需要高亮的字段</p>
</li>
<li><p>title：这里声明 title 字段需要高亮，后面可以为这个字段设置特有配置，也可以空</p>
</li>
</ul>
<p>在 Postman 中，向 ES 服务器发 GET 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"query"</span>: &#123;</span><br><span class="line">		<span class="attr">"match"</span>: &#123;</span><br><span class="line">			<span class="attr">"name"</span>: <span class="string">"zhangsan"</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"highlight"</span>: &#123;</span><br><span class="line">		<span class="attr">"pre_tags"</span>: <span class="string">"&lt;font color='red'&gt;"</span>,</span><br><span class="line">		<span class="attr">"post_tags"</span>: <span class="string">"&lt;/font&gt;"</span>,</span><br><span class="line">		<span class="attr">"fields"</span>: &#123;</span><br><span class="line">			<span class="attr">"name"</span>: &#123;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p><img src="/images/database/es/%E9%AB%98%E4%BA%AE%E6%9F%A5%E8%AF%A2-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C.png" alt="高亮查询-响应结果.png"></p>
<h4 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h4><p>from：当前页的起始索引，默认从 0 开始。 from = (pageNum - 1) * size</p>
<p>size：每页显示多少条</p>
<p>在 Postman 中，向 ES 服务器发 <strong>GET</strong> 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"query"</span>: &#123;</span><br><span class="line">		<span class="attr">"match_all"</span>: &#123;&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"sort"</span>: [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">"age"</span>: &#123;</span><br><span class="line">				<span class="attr">"order"</span>: <span class="string">"desc"</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	<span class="attr">"from"</span>: <span class="number">0</span>,</span><br><span class="line">	<span class="attr">"size"</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p><img src="/images/database/es/%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C.png" alt="分页查询-响应结果.png"></p>
<h4 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h4><p>聚合允许使用者对 es 文档进行统计分析，类似与关系型数据库中的 group by，当然还有很多其他的聚合，例如取最大值、平均值等等。</p>
<blockquote>
<p>对某个字段取最大值 max</p>
</blockquote>
<p>在 Postman 中，向 ES 服务器发 GET 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"aggs"</span>:&#123;</span><br><span class="line">		<span class="attr">"max_age"</span>:&#123;</span><br><span class="line">			<span class="attr">"max"</span>:&#123;<span class="attr">"field"</span>:<span class="string">"age"</span>&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"size"</span>:<span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p><img src="/images/database/es/%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C.png" alt="聚合查询-响应结果.png"></p>
<blockquote>
<p>对某个字段取最小值 min</p>
</blockquote>
<p>在 Postman 中，向 ES 服务器发 GET 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"aggs"</span>:&#123;</span><br><span class="line">		<span class="attr">"min_age"</span>:&#123;</span><br><span class="line">			<span class="attr">"min"</span>:&#123;<span class="attr">"field"</span>:<span class="string">"age"</span>&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"size"</span>:<span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p><img src="/images/database/es/%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C2.png" alt="聚合查询-响应结果2.png"></p>
<blockquote>
<p>对某个字段求和 sum</p>
</blockquote>
<p>在 Postman 中，向 ES 服务器发 GET 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"aggs"</span>:&#123;</span><br><span class="line">		<span class="attr">"sum_age"</span>:&#123;</span><br><span class="line">			<span class="attr">"sum"</span>:&#123;<span class="attr">"field"</span>:<span class="string">"age"</span>&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"size"</span>:<span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p><img src="/images/database/es/%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2-%E6%B1%82%E5%92%8C-%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C.png" alt="聚合查询-求和-响应结果.png"></p>
<blockquote>
<p>对某个字段取平均值 avg</p>
</blockquote>
<p>在 Postman 中，向 ES 服务器发 GET 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"aggs"</span>:&#123;</span><br><span class="line">		<span class="attr">"avg_age"</span>:&#123;</span><br><span class="line">			<span class="attr">"avg"</span>:&#123;<span class="attr">"field"</span>:<span class="string">"age"</span>&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"size"</span>:<span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p>![对某个字段取平均值 avg.png](/images/database/es/对某个字段取平均值 avg.png)</p>
<blockquote>
<p>对某个字段的值进行去重之后再取总数</p>
</blockquote>
<p>在 Postman 中，向 ES 服务器发 GET 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"aggs"</span>:&#123;</span><br><span class="line">		<span class="attr">"distinct_age"</span>:&#123;</span><br><span class="line">			<span class="attr">"cardinality"</span>:&#123;<span class="attr">"field"</span>:<span class="string">"age"</span>&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"size"</span>:<span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p><img src="/images/database/es/%E5%AF%B9%E6%9F%90%E4%B8%AA%E5%AD%97%E6%AE%B5%E7%9A%84%E5%80%BC%E8%BF%9B%E8%A1%8C%E5%8E%BB%E9%87%8D%E4%B9%8B%E5%90%8E%E5%86%8D%E5%8F%96%E6%80%BB%E6%95%B0.png" alt="对某个字段的值进行去重之后再取总数.png"></p>
<blockquote>
<p>State 聚合</p>
</blockquote>
<p>stats 聚合，对某个字段一次性返回 count，max，min，avg 和 sum 五个指标</p>
<p>在 Postman 中，向 ES 服务器发 GET 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"aggs"</span>:&#123;</span><br><span class="line">		<span class="attr">"stats_age"</span>:&#123;</span><br><span class="line">			<span class="attr">"stats"</span>:&#123;<span class="attr">"field"</span>:<span class="string">"age"</span>&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"size"</span>:<span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p>![State 聚合.png](/images/database/es/State 聚合.png)</p>
<h4 id="桶聚合查询"><a href="#桶聚合查询" class="headerlink" title="桶聚合查询"></a>桶聚合查询</h4><p>桶聚和相当于 sql 中的 group by 语句</p>
<blockquote>
<p>terms 聚合，分组统计</p>
</blockquote>
<p>在 Postman 中，向 ES 服务器发 GET 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"aggs"</span>:&#123;</span><br><span class="line">		<span class="attr">"age_groupby"</span>:&#123;</span><br><span class="line">			<span class="attr">"terms"</span>:&#123;<span class="attr">"field"</span>:<span class="string">"age"</span>&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"size"</span>:<span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p>![terms 聚合，分组统计.png](/images/database/es/terms 聚合，分组统计.png)</p>
<blockquote>
<p>在 terms 分组下再进行聚合</p>
</blockquote>
<p>在 Postman 中，向 ES 服务器发 GET 请求 ：<a href="http://127.0.0.1:9200/student/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/student/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"aggs"</span>:&#123;</span><br><span class="line">		<span class="attr">"age_groupby"</span>:&#123;</span><br><span class="line">			<span class="attr">"terms"</span>:&#123;<span class="attr">"field"</span>:<span class="string">"age"</span>&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"size"</span>:<span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器响应结果：</p>
<p>![在 terms 分组下再进行聚合.png](/images/database/es/在 terms 分组下再进行聚合.png)</p>
<h2 id="Java-API-操作"><a href="#Java-API-操作" class="headerlink" title="Java API 操作"></a><strong>Java</strong> <strong>API</strong> 操作</h2><ol>
<li><p>创建 Maven 项目</p>
</li>
<li><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.13.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- elasticsearch的客户端 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.13.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- elasticsearch依赖2.x的log4j --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- junit单元测试 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加一个测试的entity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learning.es.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String name, String sex, Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.sex = sex;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(String sex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h3 id="创建es客户端"><a href="#创建es客户端" class="headerlink" title="创建es客户端"></a>创建es客户端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 创建es客户端</span></span><br><span class="line">        RestHighLevelClient esClient = <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">                RestClient.builder(<span class="keyword">new</span> HttpHost(<span class="string">"localhost"</span>, <span class="number">9200</span>, <span class="string">"http"</span>))</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        esClient.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="doc操作"><a href="#doc操作" class="headerlink" title="doc操作"></a>doc操作</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br></pre></td><td class="code"><pre><span class="line">import com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line">import com.learning.es.entity.User;</span><br><span class="line">import org.apache.http.HttpHost;</span><br><span class="line">import org.elasticsearch.action.bulk.BulkRequest;</span><br><span class="line">import org.elasticsearch.action.bulk.BulkResponse;</span><br><span class="line">import org.elasticsearch.action.delete.DeleteRequest;</span><br><span class="line">import org.elasticsearch.action.delete.DeleteResponse;</span><br><span class="line">import org.elasticsearch.action.get.GetRequest;</span><br><span class="line">import org.elasticsearch.action.get.GetResponse;</span><br><span class="line">import org.elasticsearch.action.index.IndexRequest;</span><br><span class="line">import org.elasticsearch.action.index.IndexResponse;</span><br><span class="line">import org.elasticsearch.action.search.SearchRequest;</span><br><span class="line">import org.elasticsearch.action.search.SearchResponse;</span><br><span class="line">import org.elasticsearch.action.update.UpdateRequest;</span><br><span class="line">import org.elasticsearch.action.update.UpdateResponse;</span><br><span class="line">import org.elasticsearch.client.RequestOptions;</span><br><span class="line">import org.elasticsearch.client.RestClient;</span><br><span class="line">import org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line">import org.elasticsearch.common.unit.Fuzziness;</span><br><span class="line">import org.elasticsearch.common.unit.TimeValue;</span><br><span class="line">import org.elasticsearch.common.xcontent.XContentType;</span><br><span class="line">import org.elasticsearch.index.query.*;</span><br><span class="line">import org.elasticsearch.search.SearchHits;</span><br><span class="line">import org.elasticsearch.search.aggregations.AggregationBuilder;</span><br><span class="line">import org.elasticsearch.search.aggregations.AggregationBuilders;</span><br><span class="line">import org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line">import org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;</span><br><span class="line">import org.elasticsearch.search.sort.SortOrder;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.util.Arrays;</span><br><span class="line"></span><br><span class="line">public class Doc &#123;</span><br><span class="line">    public static RestHighLevelClient esClient;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws IOException &#123;</span><br><span class="line">        Doc testIndex = new Doc();</span><br><span class="line">        esClient = new RestHighLevelClient(</span><br><span class="line">                RestClient.builder(new HttpHost("localhost", 9200, "http"))</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        testIndex.insert();</span></span><br><span class="line"><span class="comment">//        testIndex.update();</span></span><br><span class="line"><span class="comment">//        testIndex.search();</span></span><br><span class="line"><span class="comment">//        testIndex.del();</span></span><br><span class="line"><span class="comment">//        testIndex.multiInsert();</span></span><br><span class="line"><span class="comment">//        testIndex.del();</span></span><br><span class="line"><span class="comment">//        testIndex.query();</span></span><br><span class="line">        testIndex.query2();</span><br><span class="line">        esClient.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public void insert() throws IOException &#123;</span><br><span class="line">        IndexRequest request = new IndexRequest();</span><br><span class="line">        request.index("user").id("1001");</span><br><span class="line">        User zhangsan = new User("zhangsan", "男", 30);</span><br><span class="line"></span><br><span class="line">        ObjectMapper mapper = new ObjectMapper();</span><br><span class="line">        String userJson = mapper.writeValueAsString(zhangsan);</span><br><span class="line">        request.source(userJson, XContentType.JSON);</span><br><span class="line">        IndexResponse res = esClient.index(request, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(res.getResult());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public void update() throws IOException &#123;</span><br><span class="line">        UpdateRequest request = new UpdateRequest();</span><br><span class="line">        request.index("user").id("1001");</span><br><span class="line">        request.doc(XContentType.JSON, "sex", "女");</span><br><span class="line">        UpdateResponse res = esClient.update(request, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(res.getResult());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public void search() throws IOException &#123;</span><br><span class="line">        GetRequest request = new GetRequest();</span><br><span class="line">        request.index("user").id("1001");</span><br><span class="line">        GetResponse documentFields = esClient.get(request, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(documentFields.getSourceAsString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public void del() throws IOException &#123;</span><br><span class="line">        DeleteRequest request = new DeleteRequest();</span><br><span class="line">        request.index("user").id("1001");</span><br><span class="line">        DeleteResponse delete = esClient.delete(request, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(delete.getResult());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public void multiInsert() throws IOException &#123;</span><br><span class="line">        BulkRequest bulkRequest = new BulkRequest();</span><br><span class="line"></span><br><span class="line">        ObjectMapper mapper = new ObjectMapper();</span><br><span class="line">        bulkRequest.add(new IndexRequest()</span><br><span class="line">                .index("user").id("1001")</span><br><span class="line">                .source(XContentType.JSON, "name","zhangsan", "sex","男", "age",30));</span><br><span class="line">        bulkRequest.add(new IndexRequest()</span><br><span class="line">                .index("user").id("1002")</span><br><span class="line">                .source(XContentType.JSON,"name","lisi", "sex","男", "age",30));</span><br><span class="line">        bulkRequest.add(new IndexRequest()</span><br><span class="line">                .index("user").id("1003")</span><br><span class="line">                .source(XContentType.JSON, "name","wangwu", "sex","女", "age",30));</span><br><span class="line">        bulkRequest.add(new IndexRequest()</span><br><span class="line">                .index("user").id("1004")</span><br><span class="line">                .source(XContentType.JSON, "name","zhangsan2", "sex","女", "age",40));</span><br><span class="line">        bulkRequest.add(new IndexRequest()</span><br><span class="line">                .index("user").id("1005")</span><br><span class="line">                .source(XContentType.JSON, "name","zhangsan3", "sex","男", "age",40));</span><br><span class="line">        BulkResponse res = esClient.bulk(bulkRequest, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(res.getTook());</span><br><span class="line">        System.out.println(Arrays.toString(res.getItems()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量删除</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public void multiDel() throws IOException &#123;</span><br><span class="line">        BulkRequest bulkRequest = new BulkRequest();</span><br><span class="line"></span><br><span class="line">        bulkRequest.add(new DeleteRequest()</span><br><span class="line">                .index("user").id("1001"));</span><br><span class="line">        bulkRequest.add(new DeleteRequest()</span><br><span class="line">                .index("user").id("1002"));</span><br><span class="line">        bulkRequest.add(new DeleteRequest()</span><br><span class="line">                .index("user").id("1003"));</span><br><span class="line">        bulkRequest.add(new DeleteRequest()</span><br><span class="line">                .index("user").id("1004"));</span><br><span class="line">        bulkRequest.add(new DeleteRequest()</span><br><span class="line">                .index("user").id("1005"));</span><br><span class="line">        BulkResponse res = esClient.bulk(bulkRequest, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(res.getTook());</span><br><span class="line">        System.out.println(Arrays.toString(res.getItems()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 全量查询</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public void query() throws IOException &#123;</span><br><span class="line">        SearchRequest request = new SearchRequest();</span><br><span class="line">        request.indices("user");</span><br><span class="line"></span><br><span class="line">        request.source(new SearchSourceBuilder().query(QueryBuilders.matchAllQuery()));</span><br><span class="line">        SearchResponse res = esClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        System.out.println(res.getTook());</span><br><span class="line"></span><br><span class="line">        SearchHits hits = res.getHits();</span><br><span class="line">        System.out.println(hits.getTotalHits());</span><br><span class="line">        hits.forEach((hit) -&gt; System.out.println(hit.getSourceAsString()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 条件查询</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public void query2() throws IOException &#123;</span><br><span class="line">        SearchRequest request = new SearchRequest();</span><br><span class="line">        request.indices("user");</span><br><span class="line"></span><br><span class="line"><span class="comment">//        // 单个查询</span></span><br><span class="line"><span class="comment">//        SearchSourceBuilder builder = new SearchSourceBuilder().query(QueryBuilders.matchQuery("sex", "男"));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        // 组合查询</span></span><br><span class="line"><span class="comment">//        SearchSourceBuilder builder = new SearchSourceBuilder();</span></span><br><span class="line"><span class="comment">//        BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span></span><br><span class="line"><span class="comment">//        boolQueryBuilder.must(QueryBuilders.matchQuery("sex", "男"));</span></span><br><span class="line"><span class="comment">//        boolQueryBuilder.must(QueryBuilders.matchQuery("age", "30"));</span></span><br><span class="line"><span class="comment">//        boolQueryBuilder.mustNot(QueryBuilders.matchQuery("sex", "男"));</span></span><br><span class="line"><span class="comment">//        boolQueryBuilder.should(QueryBuilders.matchQuery("age", "30"));</span></span><br><span class="line"><span class="comment">//        boolQueryBuilder.should(QueryBuilders.matchQuery("age", "40"));</span></span><br><span class="line"><span class="comment">//        builder.query(boolQueryBuilder);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        // 范围查询</span></span><br><span class="line"><span class="comment">//        SearchSourceBuilder builder = new SearchSourceBuilder();</span></span><br><span class="line"><span class="comment">//        RangeQueryBuilder rangeQuery = QueryBuilders.rangeQuery("age");</span></span><br><span class="line"><span class="comment">//        rangeQuery.gte(30).lte(35);</span></span><br><span class="line"><span class="comment">//        builder.query(rangeQuery);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        // 模糊查询</span></span><br><span class="line"><span class="comment">//        SearchSourceBuilder builder = new SearchSourceBuilder();</span></span><br><span class="line"><span class="comment">//        // fuzziness 表示偏差多少个字符可以模糊匹配出来</span></span><br><span class="line"><span class="comment">//        FuzzyQueryBuilder fuzziness = QueryBuilders.fuzzyQuery("name", "zhangsan").fuzziness(Fuzziness.ONE);</span></span><br><span class="line"><span class="comment">//        builder.query(fuzziness);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        // 高亮</span></span><br><span class="line"><span class="comment">//        SearchSourceBuilder builder = new SearchSourceBuilder();</span></span><br><span class="line"><span class="comment">//        builder.query(QueryBuilders.termQuery("name", "zhangsan"));</span></span><br><span class="line"><span class="comment">//        HighlightBuilder highlightBuilder = new HighlightBuilder();</span></span><br><span class="line"><span class="comment">//        highlightBuilder.preTags("&lt;font color='red'&gt;");</span></span><br><span class="line"><span class="comment">//        highlightBuilder.postTags("&lt;/font&gt;");</span></span><br><span class="line"><span class="comment">//        highlightBuilder.field("name");</span></span><br><span class="line"><span class="comment">//        builder.highlighter(highlightBuilder);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        // 聚合查询</span></span><br><span class="line"><span class="comment">//        SearchSourceBuilder builder = new SearchSourceBuilder();</span></span><br><span class="line"><span class="comment">//        AggregationBuilder aggregationBuilder = AggregationBuilders.max("maxAge").field("age");</span></span><br><span class="line"><span class="comment">//        builder.aggregation(aggregationBuilder);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分组查询</span></span><br><span class="line">        SearchSourceBuilder builder = new SearchSourceBuilder();</span><br><span class="line">        AggregationBuilder aggregationBuilder = AggregationBuilders.terms("ageGroup").field("age");</span><br><span class="line">        builder.aggregation(aggregationBuilder);</span><br><span class="line">        <span class="comment">// 分页</span></span><br><span class="line">        builder.from(0);</span><br><span class="line">        builder.size(5);</span><br><span class="line">        <span class="comment">// 排序</span></span><br><span class="line">        builder.sort("age", SortOrder.DESC);</span><br><span class="line"><span class="comment">//        // 过滤字段</span></span><br><span class="line"><span class="comment">//        String[] includes = &#123;"name"&#125;;</span></span><br><span class="line"><span class="comment">//        String[] excludes = &#123;&#125;;</span></span><br><span class="line"><span class="comment">//        builder.fetchSource(includes, excludes);</span></span><br><span class="line"></span><br><span class="line">        request.source(builder);</span><br><span class="line">        SearchResponse res = esClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        System.out.println(res.getTook());</span><br><span class="line"></span><br><span class="line">        SearchHits hits = res.getHits();</span><br><span class="line">        System.out.println(hits.getTotalHits());</span><br><span class="line">        hits.forEach((hit) -&gt; System.out.println(hit.getSourceAsString()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Index操作"><a href="#Index操作" class="headerlink" title="Index操作"></a>Index操作</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.http.HttpHost;</span><br><span class="line">import org.elasticsearch.action.admin.indices.delete.DeleteIndexRequest;</span><br><span class="line">import org.elasticsearch.action.support.master.AcknowledgedResponse;</span><br><span class="line">import org.elasticsearch.client.RequestOptions;</span><br><span class="line">import org.elasticsearch.client.RestClient;</span><br><span class="line">import org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line">import org.elasticsearch.client.indices.CreateIndexRequest;</span><br><span class="line">import org.elasticsearch.client.indices.CreateIndexResponse;</span><br><span class="line">import org.elasticsearch.client.indices.GetIndexRequest;</span><br><span class="line">import org.elasticsearch.client.indices.GetIndexResponse;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class Index &#123;</span><br><span class="line">    public static RestHighLevelClient esClient;</span><br><span class="line">    public static void main(String[] args) throws IOException &#123;</span><br><span class="line">        Index testIndex = new Index();</span><br><span class="line">        esClient = new RestHighLevelClient(</span><br><span class="line">                RestClient.builder(new HttpHost("localhost", 9200, "http"))</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        testIndex.create();</span></span><br><span class="line">        testIndex.search();</span><br><span class="line"><span class="comment">//        testIndex.delete();</span></span><br><span class="line">        esClient.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建索引</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public void create () throws IOException &#123;</span><br><span class="line">        <span class="comment">// 创建索引</span></span><br><span class="line">        CreateIndexRequest user = new CreateIndexRequest("user");</span><br><span class="line">        CreateIndexResponse createIndexResponse = esClient.indices().create(user, RequestOptions.DEFAULT);</span><br><span class="line">        boolean acknowledged = createIndexResponse.isAcknowledged();</span><br><span class="line">        System.out.println(acknowledged);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建索引</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public void search () throws IOException &#123;</span><br><span class="line">        <span class="comment">// 创建索引</span></span><br><span class="line">        GetIndexRequest user = new GetIndexRequest("user");</span><br><span class="line">        GetIndexResponse getIndexResponse = esClient.indices().get(user, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(getIndexResponse.getAliases());</span><br><span class="line">        System.out.println(getIndexResponse.getMappings());</span><br><span class="line">        System.out.println(getIndexResponse.getSettings());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建索引</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public void delete () throws IOException &#123;</span><br><span class="line">        <span class="comment">// 创建索引</span></span><br><span class="line">        DeleteIndexRequest user = new DeleteIndexRequest("user");</span><br><span class="line">        AcknowledgedResponse delete = esClient.indices().delete(user, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(delete.isAcknowledged());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h2><p>略</p>
<h1 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h1><h2 id="路由计算-amp-分片控制"><a href="#路由计算-amp-分片控制" class="headerlink" title="路由计算 &amp; 分片控制"></a>路由计算 &amp; 分片控制</h2><p>公式：shard = hash(routing) % number_of_primary_shards</p>
<p>routing 是一个可变值，默认是文档的 _id ，也可以设置成一个自定义的值。 routing 通过hash 函数生成一个数字，然后这个数字再除以 number_of_primary_shards （主分片的数量）后得到余数 。这个分布在 0 到 number_of_primary_shards-1 之间的余数，就是我们所寻求的文档所在分片的位置。</p>
<h3 id="分片控制"><a href="#分片控制" class="headerlink" title="分片控制"></a>分片控制</h3><p>我们可以发送请求到集群中的任一节点。每个节点都有能力处理任意请求。每个节点都知道集群中任一文档位置，所以可以直接将请求转发到需要的节点上。在下面的例子中，如果将所有的请求发送到Node 1001，我们将其称为协调节点<strong>coordinating node</strong>。</p>
<p><img src="/images/database/es/%E5%88%86%E7%89%87%E6%8E%A7%E5%88%B6.png" alt="分片控制.png"></p>
<p>当发送请求的时候， 为了扩展负载，更好的做法是轮询集群中所有的节点。</p>
<h2 id="数据写流程"><a href="#数据写流程" class="headerlink" title="数据写流程"></a>数据写流程</h2><p>新建、索引和删除请求都是写操作， 必须在主分片上面完成之后才能被复制到相关的副本分片。</p>
<p><img src="/images/database/es/%E6%95%B0%E6%8D%AE%E5%86%99%E6%B5%81%E7%A8%8B.png" alt="数据写流程.png"></p>
<p>在客户端收到成功响应时，文档变更已经在主分片和所有副本分片执行完成，变更是安全的。有一些可选的请求参数允许您影响这个过程，可能以数据安全为代价提升性能。这些选项很少使用，因为 Elasticsearch 已经很快，但是为了完整起见， 请参考下文：</p>
<ul>
<li>consistency<br>即一致性。在默认设置下，即使仅仅是在试图执行一个写操作之前，主分片都会要求必须要有规定数量quorum（或者换种说法，也即必须要有大多数）的分片副本处于活跃可用状态，才会去执行写操作（其中分片副本 可以是主分片或者副本分片）。这是为了避免在发生网络分区故障（network partition）的时候进行写操作，进而导致数据不一致。 规定数量即： int((primary + number_of_replicas) / 2 ) + 1</li>
<li>consistency 参数的值可以设为：<ul>
<li>one ：只要主分片状态 ok 就允许执行写操作。</li>
<li>all：必须要主分片和所有副本分片的状态没问题才允许执行写操作。</li>
<li>quorum：默认值为quorum , 即大多数的分片副本状态没问题就允许执行写操作。</li>
</ul>
</li>
<li>注意，规定数量的计算公式中number_of_replicas指的是在索引设置中的设定副本分片数，而不是指当前处理活动状态的副本分片数。如果你的索引设置中指定了当前索引拥有3个副本分片，那规定数量的计算结果即：int((1 primary + 3 replicas) / 2) + 1 = 3，如果此时你只启动两个节点，那么处于活跃状态的分片副本数量就达不到规定数量，也因此您将无法索引和删除任何文档。</li>
<li>timeout<ol>
<li>如果没有足够的副本分片会发生什么？Elasticsearch 会等待，希望更多的分片出现。默认情况下，它最多等待 1 分钟。 如果你需要，你可以使用timeout参数使它更早终止：100是100 毫秒，30s是30秒。</li>
</ol>
</li>
</ul>
<p>新索引默认有1个副本分片，这意味着为满足规定数量应该需要两个活动的分片副本。 但是，这些默认的设置会阻止我们在单一节点上做任何事情。为了避免这个问题，要求只有当number_of_replicas 大于1的时候，规定数量才会执行。</p>
<h2 id="数据读流程"><a href="#数据读流程" class="headerlink" title="数据读流程"></a>数据读流程</h2><p><img src="/images/database/es/%E6%95%B0%E6%8D%AE%E8%AF%BB%E6%B5%81%E7%A8%8B.png" alt="数据读流程.png"></p>
<p>在处理读取请求时，协调结点在每次请求的时候都会通过轮询所有的副本分片来达到负载均衡。在文档被检索时，已经被索引的文档可能已经存在于主分片上但是还没有复制到副本分片。 在这种情况下，副本分片可能会报告文档不存在，但是主分片可能成功返回文档。 一旦索引请求成功返回给用户，文档在主分片和副本分片都是可用的。</p>
<h2 id="更新流程-amp-批量操作流程"><a href="#更新流程-amp-批量操作流程" class="headerlink" title="更新流程 &amp; 批量操作流程"></a>更新流程 &amp; 批量操作流程</h2><h3 id="更新流程"><a href="#更新流程" class="headerlink" title="更新流程"></a>更新流程</h3><p>部分更新一个文档结合了先前说明的读取和写入流程：</p>
<p><img src="/images/database/es/%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B.png" alt="更新流程.png"></p>
<p>部分更新一个文档的步骤如下：</p>
<ol>
<li>客户端向Node 1发送更新请求。</li>
<li>它将请求转发到主分片所在的Node 3 。</li>
<li>Node 3从主分片检索文档，修改_source字段中的JSON，并且尝试重新索引主分片的文档。如果文档已经被另一个进程修改,它会重试步骤3 ,超过retry_on_conflict次后放弃。</li>
<li>如果 Node 3成功地更新文档，它将新版本的文档并行转发到Node 1和 Node 2上的副本分片，重新建立索引。一旦所有副本分片都返回成功，Node 3向协调节点也返回成功，协调节点向客户端返回成功。</li>
</ol>
<p>当主分片把更改转发到副本分片时， 它不会转发更新请求。 相反，它转发完整文档的新版本。请记住，这些更改将会异步转发到副本分片，并且不能保证它们以发送它们相同的顺序到达。 如果 Elasticsearch 仅转发更改请求，则可能以错误的顺序应用更改，导致得到损坏的文档。</p>
<h3 id="批量操作流程"><a href="#批量操作流程" class="headerlink" title="批量操作流程"></a>批量操作流程</h3><p><strong>mget和 bulk API的模式类似于单文档模式。</strong>区别在于协调节点知道每个文档存在于哪个分片中。它将整个多文档请求分解成每个分片的多文档请求，并且将这些请求并行转发到每个参与节点。</p>
<p>协调节点一旦收到来自每个节点的应答，就将每个节点的响应收集整理成单个响应，返回给客户端。</p>
<p><img src="/images/database/es/%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B.png" alt="批量操作流程.png"></p>
<p><strong>用单个 mget 请求取回多个文档所需的步骤顺序:</strong></p>
<ol>
<li>客户端向 Node 1 发送 mget 请求。</li>
<li>Node 1为每个分片构建多文档获取请求，然后并行转发这些请求到托管在每个所需的主分片或者副本分片的节点上。一旦收到所有答复，Node 1 构建响应并将其返回给客户端。</li>
</ol>
<p>可以对docs数组中每个文档设置routing参数。</p>
<p>bulk API， 允许在单个批量请求中执行多个创建、索引、删除和更新请求。</p>
<p><img src="/images/database/es/%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B2.png" alt="批量操作流程2.png"></p>
<p><strong>bulk API 按如下步骤顺序执行：</strong></p>
<ol>
<li>客户端向Node 1 发送 bulk请求。</li>
<li>Node 1为每个节点创建一个批量请求，并将这些请求并行转发到每个包含主分片的节点主机。</li>
<li>主分片一个接一个按顺序执行每个操作。当每个操作成功时,主分片并行转发新文档（或删除）到副本分片，然后执行下一个操作。一旦所有的副本分片报告所有操作成功，该节点将向协调节点报告成功，协调节点将这些响应收集整理并返回给客户端</li>
</ol>
<h2 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h2><p>分片是Elasticsearch最小的工作单元。但是究竟什么是一个分片，它是如何工作的？</p>
<p>传统的数据库每个字段存储单个值，但这对全文检索并不够。文本字段中的每个单词需要被搜索，对数据库意味着需要单个字段有索引多值的能力。最好的支持是一个字段多个值需求的数据结构是倒排索引。</p>
<h3 id="倒排索引原理"><a href="#倒排索引原理" class="headerlink" title="倒排索引原理"></a>倒排索引原理</h3><p>Elasticsearch使用一种称为倒排索引的结构，它适用于快速的全文搜索。</p>
<p>见其名，知其意，有倒排索引，肯定会对应有正向索引。正向索引（forward index），反向索引（inverted index）更熟悉的名字是倒排索引。</p>
<p>所谓的正向索引，就是搜索引擎会将待搜索的文件都对应一个文件ID，搜索时将这个ID和搜索关键字进行对应，形成K-V对，然后对关键字进行统计计数。（统计？？下文有解释）</p>
<p><img src="/images/database/es/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E5%8E%9F%E7%90%86-%E6%AD%A3%E5%90%91%E7%B4%A2%E5%BC%95.png" alt="倒排索引原理-正向索引.png"></p>
<p>但是互联网上收录在搜索引擎中的文档的数目是个天文数字，这样的索引结构根本无法满足实时返回排名结果的要求。所以，搜索引擎会将正向索引重新构建为倒排索引，即把文件ID对应到关键词的映射转换为关键词到文件ID的映射，每个关键词都对应着一系列的文件，这些文件中都出现这个关键词。</p>
<p><img src="/images/database/es/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E5%8E%9F%E7%90%86-%E5%8F%8D%E5%90%91%E7%B4%A2%E5%BC%95.png" alt="倒排索引原理-反向索引.png"></p>
<h3 id="倒排索引的例子"><a href="#倒排索引的例子" class="headerlink" title="倒排索引的例子"></a>倒排索引的例子</h3><p>一个倒排索引由文档中所有不重复词的列表构成，对于其中每个词，有一个包含它的文档列表。例如，假设我们有两个文档，每个文档的content域包含如下内容：</p>
<ul>
<li>The quick brown fox jumped over the lazy dog</li>
<li>Quick brown foxes leap over lazy dogs in summer</li>
</ul>
<p>为了创建倒排索引，我们首先将每个文档的content域拆分成单独的词（我们称它为词条或tokens )，创建一个包含所有不重复词条的排序列表，然后列出每个词条出现在哪个文档。结果如下所示：</p>
<p><img src="/images/database/es/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BE%8B%E5%AD%90.png" alt="倒排索引的例子.png"></p>
<p>现在，如果我们想搜索 quick brown ，我们只需要查找包含每个词条的文档：</p>
<p><img src="/images/database/es/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BE%8B%E5%AD%902.png" alt="倒排索引的例子2.png"></p>
<p>两个文档都匹配，但是第一个文档比第二个匹配度更高。如果我们使用仅计算匹配词条数量的简单相似性算法，那么我们可以说，对于我们查询的相关性来讲，第一个文档比第二个文档更佳。</p>
<p>但是，我们目前的倒排索引有一些问题：</p>
<ul>
<li><p>Quick和quick以独立的词条出现，然而用户可能认为它们是相同的词。</p>
</li>
<li><p>fox和foxes非常相似，就像dog和dogs；他们有相同的词根。</p>
</li>
<li><p>jumped和leap，尽管没有相同的词根，但他们的意思很相近。他们是同义词。</p>
</li>
</ul>
<p>使用前面的索引搜索+Quick +fox不会得到任何匹配文档。(记住，＋前缀表明这个词必须存在）。</p>
<p>只有同时出现Quick和fox 的文档才满足这个查询条件，但是第一个文档包含quick fox ，第二个文档包含Quick foxes 。</p>
<p>我们的用户可以合理的期望两个文档与查询匹配。我们可以做的更好。</p>
<p>如果我们将词条规范为标准模式，那么我们可以找到与用户搜索的词条不完全一致，但具有足够相关性的文档。例如：</p>
<ul>
<li>Quick可以小写化为quick。</li>
<li>foxes可以词干提取变为词根的格式为fox。类似的，dogs可以为提取为dog。</li>
<li>jumped和leap是同义词，可以索引为相同的单词jump 。</li>
</ul>
<p>现在索引看上去像这样：</p>
<p><img src="/images/database/es/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BE%8B%E5%AD%903.png" alt="倒排索引的例子3.png"></p>
<p>这还远远不够。我们搜索+Quick +fox 仍然会失败，因为在我们的索引中，已经没有Quick了。但是，如果我们对搜索的字符串使用与content域相同的标准化规则，会变成查询+quick +fox，这样两个文档都会匹配！分词和标准化的过程称为分析，这非常重要。你只能搜索在索引中出现的词条，所以索引文本和查询字符串必须标准化为相同的格式。</p>
<h2 id="文档搜索"><a href="#文档搜索" class="headerlink" title="文档搜索"></a>文档搜索</h2><h3 id="不可改变的倒排索引"><a href="#不可改变的倒排索引" class="headerlink" title="不可改变的倒排索引"></a>不可改变的倒排索引</h3><p>早期的全文检索会为整个文档集合建立一个很大的倒排索引并将其写入到磁盘。 一旦新的索引就绪，旧的就会被其替换，这样最近的变化便可以被检索到。</p>
<p>倒排索引被写入磁盘后是不可改变的：它永远不会修改。</p>
<ul>
<li><p>不需要锁。如果你从来不更新索引，你就不需要担心多进程同时修改数据的问题。</p>
</li>
<li><p>一旦索引被读入内核的文件系统缓存，便会留在哪里，由于其不变性。只要文件系统缓存中还有足够的空间，那么大部分读请求会直接请求内存，而不会命中磁盘。这提供了很大的性能提升。</p>
</li>
<li><p>其它缓存(像filter缓存)，在索引的生命周期内始终有效。它们不需要在每次数据改变时被重建，因为数据不会变化。</p>
</li>
<li><p>写入单个大的倒排索引允许数据被压缩，减少磁盘IO和需要被缓存到内存的索引的使用量。</p>
</li>
</ul>
<p>当然，一个不变的索引也有不好的地方。主要事实是它是不可变的! 你不能修改它。如果你需要让一个新的文档可被搜索，你需要重建整个索引。这要么对一个索引所能包含的数据量造成了很大的限制，要么对索引可被更新的频率造成了很大的限制。</p>
<h3 id="动态更新索引"><a href="#动态更新索引" class="headerlink" title="动态更新索引"></a>动态更新索引</h3><p>如何在保留不变性的前提下实现倒排索引的更新？</p>
<p>答案是：用更多的索引。通过增加新的补充索引来反映新近的修改，而不是直接重写整个倒排索引。每一个倒排索引都会被轮流查询到,从最早的开始查询完后再对结果进行合并。</p>
<p>Elasticsearch基于Lucene，这个java库引入了按段搜索的概念。每一段本身都是一个倒排索引，但索引在 Lucene 中除表示所有段的集合外，还增加了提交点的概念—一个列出了所有已知段的文件。</p>
<p>按段搜索会以如下流程执行：</p>
<p>一、新文档被收集到内存索引缓存。</p>
<p><img src="/images/database/es/%E5%8A%A8%E6%80%81%E6%9B%B4%E6%96%B0%E7%B4%A2%E5%BC%95-%E6%96%B0%E6%96%87%E6%A1%A3%E8%A2%AB%E6%94%B6%E9%9B%86%E5%88%B0%E5%86%85%E5%AD%98%E7%B4%A2%E5%BC%95%E7%BC%93%E5%AD%98.png" alt="动态更新索引-新文档被收集到内存索引缓存.png"></p>
<p>二、不时地, 缓存被提交。</p>
<ol>
<li>一个新的段，一个追加的倒排索引，被写入磁盘。</li>
<li>一个新的包含新段名字的提交点被写入磁盘。</li>
<li>磁盘进行同步，所有在文件系统缓存中等待的写入都刷新到磁盘，以确保它们被写入物理文件</li>
</ol>
<p>三、新的段被开启，让它包含的文档可见以被搜索。</p>
<p>四、内存缓存被清空，等待接收新的文档。</p>
<p><img src="/images/database/es/%E5%8A%A8%E6%80%81%E6%9B%B4%E6%96%B0%E7%B4%A2%E5%BC%95-%E5%86%85%E5%AD%98%E7%BC%93%E5%AD%98%E6%B8%85%E7%A9%BA.png" alt="动态更新索引-内存缓存清空.png"></p>
<p>当一个查询被触发，所有已知的段按顺序被查询。词项统计会对所有段的结果进行聚合，以保证每个词和每个文档的关联都被准确计算。这种方式可以用相对较低的成本将新文档添加到索引。</p>
<p>段是不可改变的，所以既不能从把文档从旧的段中移除，也不能修改旧的段来进行反映文档的更新。取而代之的是，每个提交点会包含一个.del 文件，文件中会列出这些被删除文档的段信息。</p>
<p>当一个<strong>文档被“删除”</strong>时，它实际上只是在 .del 文件中被标记删除。一个被标记删除的文档仍然可以被查询匹配到，但它会在最终结果被返回前从结果集中移除。</p>
<p><strong>文档更新</strong>也是类似的操作方式:当一个文档被更新时，旧版本文档被标记删除，文档的新版本被索引到一个新的段中。可能两个版本的文档都会被一个查询匹配到，但被删除的那个旧版本文档在结果集返回前就已经被移除。</p>
<h2 id="文档刷新-amp-文档刷写-amp-文档合并"><a href="#文档刷新-amp-文档刷写-amp-文档合并" class="headerlink" title="文档刷新 &amp; 文档刷写 &amp; 文档合并"></a>文档刷新 &amp; 文档刷写 &amp; 文档合并</h2><p><img src="/images/database/es/%E8%BF%91%E5%AE%9E%E6%97%B6%E6%90%9C%E7%B4%A2.png" alt="近实时搜索.png"></p>
<p>![文档刷新 &amp; 文档刷写.png](/images/database/es/文档刷新 &amp; 文档刷写.png)</p>
<h3 id="近实时搜索"><a href="#近实时搜索" class="headerlink" title="近实时搜索"></a>近实时搜索</h3><p>随着按段（per-segment）搜索的发展，一个新的文档从索引到可被搜索的延迟显著降低了。新文档在几分钟之内即可被检索，但这样还是不够快。磁盘在这里成为了瓶颈。<strong>提交（Commiting）一个新的段到磁盘需要一个fsync来确保段被物理性地写入磁盘</strong>，这样在断电的时候就不会丢失数据。但是fsync操作代价很大；如果每次索引一个文档都去执行一次的话会造成很大的性能问题。</p>
<p>我们需要的是一个更轻量的方式来使一个文档可被搜索，这意味着fsync要从整个过程中被移除。在Elasticsearch和磁盘之间是<strong>文件系统缓存</strong>。像之前描述的一样，在内存索引缓冲区中的文档会被写入到一个新的段中。但是这里新段会被先写入到文件系统缓存—这一步代价会比较低，稍后再被刷新到磁盘—这一步代价比较高。不过只要文件已经在缓存中，就可以像其它文件一样被打开和读取了。</p>
<p><img src="/images/database/es/%E8%BF%91%E5%AE%9E%E6%97%B6%E6%90%9C%E7%B4%A22.png" alt="近实时搜索2.png"></p>
<p>Lucene允许新段被写入和打开，使其包含的文档在未进行一次完整提交时便对搜索可见。这种方式比进行一次提交代价要小得多，并且在不影响性能的前提下可以被频繁地执行。</p>
<p><img src="/images/database/es/%E8%BF%91%E5%AE%9E%E6%97%B6%E6%90%9C%E7%B4%A23.png" alt="近实时搜索3.png"></p>
<p>在 Elasticsearch 中，写入和打开一个新段的轻量的过程叫做refresh。默认情况下每个分片会每秒自动刷新一次。这就是为什么我们说 Elasticsearch是近实时搜索：文档的变化并不是立即对搜索可见，但会在一秒之内变为可见。</p>
<p>这些行为可能会对新用户造成困惑：他们索引了一个文档然后尝试搜索它，但却没有搜到。这个问题的解决办法是用refresh API执行一次手动刷新：/usersl_refresh</p>
<p>尽管刷新是比提交轻量很多的操作，它还是会有性能开销。当写测试的时候，手动刷新很有用，但是不要在生产环境下每次索引一个文档都去手动刷新。相反，你的应用需要意识到Elasticsearch 的近实时的性质，并接受它的不足。</p>
<p>并不是所有的情况都需要每秒刷新。可能你正在使用Elasticsearch索引大量的日志文件，你可能想优化索引速度而不是近实时搜索，可以通过设置refresh_interval ，降低每个索引的刷新频率</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    	<span class="attr">"refresh_interval"</span>: <span class="string">"30s"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>refresh_interval可以在既存索引上进行动态更新。在生产环境中，当你正在建立一个大的新索引时，可以先关闭自动刷新，待开始使用该索引时，再把它们调回来。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 关闭自动刷新</span><br><span class="line">PUT /users/_settings</span><br><span class="line">&#123; <span class="attr">"refresh_interval"</span>: <span class="number">-1</span> &#125;</span><br><span class="line"></span><br><span class="line"># 每一秒刷新</span><br><span class="line">PUT /users/_settings</span><br><span class="line">&#123; <span class="attr">"refresh_interval"</span>: <span class="string">"1s"</span> &#125;</span><br></pre></td></tr></table></figure>



<h3 id="持久化变更"><a href="#持久化变更" class="headerlink" title="持久化变更"></a>持久化变更</h3><p>如果没有用fsync把数据从文件系统缓存刷（flush）到硬盘，我们不能保证数据在断电甚至是程序正常退出之后依然存在。为了保证Elasticsearch 的可靠性，需要确保数据变化被持久化到磁盘。在动态更新索引，我们说一次完整的提交会将段刷到磁盘，并写入一个包含所有段列表的提交点。Elasticsearch 在启动或重新打开一个索引的过程中使用这个提交点来判断哪些段隶属于当前分片。</p>
<p>即使通过每秒刷新(refresh）实现了近实时搜索，我们仍然需要经常进行完整提交来确保能从失败中恢复。但在两次提交之间发生变化的文档怎么办?我们也不希望丢失掉这些数据。Elasticsearch 增加了一个translog ，或者叫事务日志，在每一次对Elasticsearch进行操作时均进行了日志记录。</p>
<p>整个流程如下:</p>
<p>一、一个文档被索引之后，就会被添加到内存缓冲区，并且追加到了 translog</p>
<p><img src="/images/database/es/%E6%8C%81%E4%B9%85%E5%8C%96%E5%8F%98%E6%9B%B4.png" alt="持久化变更.png"></p>
<p>二、刷新（refresh）使分片每秒被刷新（refresh）一次：</p>
<ul>
<li>这些在内存缓冲区的文档被写入到一个新的段中，且没有进行fsync操作。</li>
<li>这个段被打开，使其可被搜索。</li>
<li>内存缓冲区被清空。</li>
</ul>
<p><img src="/images/database/es/%E6%8C%81%E4%B9%85%E5%8C%96%E5%8F%98%E6%9B%B42.png" alt="持久化变更2.png"></p>
<p>三、这个进程继续工作，更多的文档被添加到内存缓冲区和追加到事务日志。</p>
<p><img src="/images/database/es/%E6%8C%81%E4%B9%85%E5%8C%96%E5%8F%98%E6%9B%B43.png" alt="持久化变更3.png"></p>
<p>四、每隔一段时间—例如translog变得越来越大，索引被刷新（flush）；一个新的translog被创建，并且一个全量提交被执行。</p>
<ul>
<li><p>所有在内存缓冲区的文档都被写入一个新的段。</p>
</li>
<li><p>缓冲区被清空。</p>
</li>
<li><p>一个提交点被写入硬盘。</p>
</li>
<li><p>文件系统缓存通过fsync被刷新（flush） 。</p>
</li>
<li><p>老的translog被删除。</p>
</li>
</ul>
<p>translog 提供所有还没有被刷到磁盘的操作的一个持久化纪录。当Elasticsearch启动的时候，它会从磁盘中使用最后一个提交点去恢复己知的段，并且会重放translog 中所有在最后一次提交后发生的变更操作。</p>
<p>translog 也被用来提供实时CRUD。当你试着通过ID查询、更新、删除一个文档，它会在尝试从相应的段中检索之前，首先检查 translog任何最近的变更。这意味着它总是能够实时地获取到文档的最新版本。</p>
<p><img src="/images/database/es/%E6%8C%81%E4%B9%85%E5%8C%96%E5%8F%98%E6%9B%B44.png" alt="持久化变更4.png"></p>
<p>执行一个提交并且截断translog 的行为在 Elasticsearch被称作一次flush。分片每30分钟被自动刷新（flush)，或者在 translog 太大的时候也会刷新。</p>
<p>你很少需要自己手动执行flush操作，通常情况下，自动刷新就足够了。这就是说，在重启节点或关闭索引之前执行 flush有益于你的索引。当Elasticsearch尝试恢复或重新打开一个索引，它需要重放translog中所有的操作，所以如果日志越短，恢复越快。</p>
<p>translog 的目的是保证操作不会丢失，在文件被fsync到磁盘前，被写入的文件在重启之后就会丢失。默认translog是每5秒被fsync刷新到硬盘，或者在每次写请求完成之后执行（e.g. index, delete, update, bulk）。这个过程在主分片和复制分片都会发生。最终，基本上，这意味着在整个请求被fsync到主分片和复制分片的translog之前，你的客户端不会得到一个200 OK响应。</p>
<p>在每次请求后都执行一个fsync会带来一些性能损失，尽管实践表明这种损失相对较小（特别是 bulk 导入，它在一次请求中平摊了大量文档的开销）。</p>
<p>但是对于一些大容量的偶尔丢失几秒数据问题也并不严重的集群，使用异步的 fsync还是比较有益的。比如，写入的数据被缓存到内存中，再每5秒执行一次 fsync 。如果你决定使用异步translog 的话，你需要保证在发生 crash 时，丢失掉 sync_interval时间段的数据也无所谓。请在决定前知晓这个特性。如果你不确定这个行为的后果，最好是使用默认的参数{“index.translog.durability”: “request”}来避免数据丢失。</p>
<h3 id="段合并"><a href="#段合并" class="headerlink" title="段合并"></a>段合并</h3><p>由于自动刷新流程每秒会创建一个新的段，这样会导致短时间内的段数量暴增。而段数目太多会带来较大的麻烦。每一个段都会消耗文件句柄、内存和 cpu运行周期。更重要的是，每个搜索请求都必须轮流检查每个段；所以段越多，搜索也就越慢。</p>
<p>Elasticsearch通过在后台进行段合并来解决这个问题。小的段被合并到大的段，然后这些大的段再被合并到更大的段。</p>
<p>段合并的时候会将那些旧的已删除文档从文件系统中清除。被删除的文档（或被更新文档的旧版本）不会被拷贝到新的大段中。</p>
<p>启动段合并不需要你做任何事。进行索引和搜索时会自动进行。</p>
<p>一、当索引的时候，刷新（refresh）操作会创建新的段并将段打开以供搜索使用。</p>
<p>二、合并进程选择一小部分大小相似的段，并且在后台将它们合并到更大的段中。这并不会中断索引和搜索。</p>
<p><img src="/images/database/es/%E6%AE%B5%E5%90%88%E5%B9%B6.png" alt="段合并.png"></p>
<p>三、一旦合并结束，老的段被删除</p>
<ul>
<li>新的段被刷新(flush)到了磁盘。</li>
<li>写入一个包含新段且排除旧的和较小的段的新提交点。</li>
<li>新的段被打开用来搜索。老的段被删除。</li>
</ul>
<p>合并大的段需要消耗大量的 I/O 和 CPU 资源，如果任其发展会影响搜索性能。 Elasticsearch在默认情况下会对合并流程进行资源限制，所以搜索仍然有足够的资源很好地执行。</p>
<h2 id="文档分析"><a href="#文档分析" class="headerlink" title="文档分析"></a>文档分析</h2><p>分析包含下面的过程：</p>
<ul>
<li>将一块文本分成适合于倒排索引的独立的词条。</li>
<li>将这些词条统一化为标准格式以提高它们的“可搜索性”，或者recall。</li>
</ul>
<p>分析器执行上面的工作。分析器实际上是将三个功能封装到了一个包里：</p>
<ul>
<li>字符过滤器：首先，字符串按顺序通过每个 字符过滤器 。他们的任务是在分词前整理字符串。一个字符过滤器可以用来去掉 HTML，或者将 &amp; 转化成 and。</li>
<li>分词器：其次，字符串被分词器分为单个的词条。一个简单的分词器遇到空格和标点的时候，可能会将文本拆分成词条。</li>
<li>Token 过滤器：最后，词条按顺序通过每个 token 过滤器 。这个过程可能会改变词条（例如，小写化Quick ），删除词条（例如， 像 a， and， the 等无用词），或者增加词条（例如，像jump和leap这种同义词）</li>
</ul>
<h2 id="文档控制"><a href="#文档控制" class="headerlink" title="文档控制"></a>文档控制</h2><p>使用乐观锁（版本号）</p>
<h1 id="SpringData集成"><a href="#SpringData集成" class="headerlink" title="SpringData集成"></a>SpringData集成</h1><p><a href="https://spring.io/projects/spring-data-elasticsearch" target="_blank" rel="noopener">Spring Data Elasticsearch 官网</a></p>
<ol>
<li><p>创建Maven项目。</p>
</li>
<li><p>修改pom文件，增加依赖关系。</p>
</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lun<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringDataWithES<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>增加配置文件application.properties</li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># es 服务地址</span></span><br><span class="line"><span class="meta">elasticsearch.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="comment"># es 服务端口</span></span><br><span class="line"><span class="meta">elasticsearch.port</span>=<span class="string">9200</span></span><br><span class="line"><span class="comment"># 配置日志级别,开启 debug 日志</span></span><br><span class="line"><span class="meta">logging.level.com.atguigu.es</span>=<span class="string">debug</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>主启动类</li>
<li>数据实体类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.Document;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.Field;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.FieldType;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Document</span>(indexName = <span class="string">"shopping"</span>, shards = <span class="number">3</span>, replicas = <span class="number">1</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">    <span class="comment">//必须有 id,这里的 id 是全局唯一的标识，等同于 es 中的"_id"</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;<span class="comment">//商品唯一标识</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * type : 字段数据类型</span></span><br><span class="line"><span class="comment">     * analyzer : 分词器类型</span></span><br><span class="line"><span class="comment">     * index : 是否索引(默认:true)</span></span><br><span class="line"><span class="comment">     * Keyword : 短语,不进行分词</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Field</span>(type = FieldType.Text, analyzer = <span class="string">"ik_max_word"</span>)</span><br><span class="line">    <span class="keyword">private</span> String title;<span class="comment">//商品名称</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field</span>(type = FieldType.Keyword)</span><br><span class="line">    <span class="keyword">private</span> String category;<span class="comment">//分类名称</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field</span>(type = FieldType.Double)</span><br><span class="line">    <span class="keyword">private</span> Double price;<span class="comment">//商品价格</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field</span>(type = FieldType.Keyword, index = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> String images;<span class="comment">//图片地址</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>配置类</li>
</ol>
<ul>
<li>ElasticsearchRestTemplate是spring-data-elasticsearch项目中的一个类,和其他spring项目中的 template类似。</li>
<li>在新版的spring-data-elasticsearch 中，ElasticsearchRestTemplate 代替了原来的ElasticsearchTemplate。</li>
<li>原因是ElasticsearchTemplate基于TransportClient，TransportClient即将在8.x 以后的版本中移除。所以，我们推荐使用ElasticsearchRestTemplate。</li>
<li>ElasticsearchRestTemplate基于RestHighLevelClient客户端的。需要自定义配置类，继承AbstractElasticsearchConfiguration，并实现elasticsearchClient()抽象方法，创建RestHighLevelClient对象。</li>
</ul>
<p>需要自定义配置类，继承AbstractElasticsearchConfiguration，并实现elasticsearchClient()抽象方法，创建RestHighLevelClient对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClientBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.config.AbstractElasticsearchConfiguration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"elasticsearch"</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticsearchConfig</span> <span class="keyword">extends</span> <span class="title">AbstractElasticsearchConfiguration</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String host ;</span><br><span class="line">    <span class="keyword">private</span> Integer port ;</span><br><span class="line">    <span class="comment">//重写父类方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestHighLevelClient <span class="title">elasticsearchClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RestClientBuilder builder = RestClient.builder(<span class="keyword">new</span> HttpHost(host, port));</span><br><span class="line">        RestHighLevelClient restHighLevelClient = <span class="keyword">new</span></span><br><span class="line">                RestHighLevelClient(builder);</span><br><span class="line">        <span class="keyword">return</span> restHighLevelClient;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>DAO 数据访问对象</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.lun.model.Product;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.repository.ElasticsearchRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductDao</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">Product</span>, <span class="title">Long</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="框架集成-SpringData-集成测试-索引操作"><a href="#框架集成-SpringData-集成测试-索引操作" class="headerlink" title="框架集成-SpringData-集成测试-索引操作"></a>框架集成-SpringData-集成测试-索引操作</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.lun.model.Product;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.ElasticsearchRestTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">SpringDataESIndexTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">//注入 ElasticsearchRestTemplate</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchRestTemplate elasticsearchRestTemplate;</span><br><span class="line">    <span class="comment">//创建索引并增加映射配置</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createIndex</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//创建索引，系统初始化会自动创建索引</span></span><br><span class="line">        System.out.println(<span class="string">"创建索引"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteIndex</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//创建索引，系统初始化会自动创建索引</span></span><br><span class="line">        <span class="keyword">boolean</span> flg = elasticsearchRestTemplate.deleteIndex(Product<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(<span class="string">"删除索引 = "</span> + flg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="框架集成-SpringData-集成测试-文档操作"><a href="#框架集成-SpringData-集成测试-文档操作" class="headerlink" title="框架集成-SpringData-集成测试-文档操作"></a>框架集成-SpringData-集成测试-文档操作</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.lun.dao.ProductDao;</span><br><span class="line"><span class="keyword">import</span> com.lun.model.Product;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.PageRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Sort;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">SpringDataESProductDaoTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductDao productDao;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Product product = <span class="keyword">new</span> Product();</span><br><span class="line">        product.setId(<span class="number">2L</span>);</span><br><span class="line">        product.setTitle(<span class="string">"华为手机"</span>);</span><br><span class="line">        product.setCategory(<span class="string">"手机"</span>);</span><br><span class="line">        product.setPrice(<span class="number">2999.0</span>);</span><br><span class="line">        product.setImages(<span class="string">"http://www.atguigu/hw.jpg"</span>);</span><br><span class="line">        productDao.save(product);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//POSTMAN, GET http://localhost:9200/product/_doc/2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//修改</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Product product = <span class="keyword">new</span> Product();</span><br><span class="line">        product.setId(<span class="number">2L</span>);</span><br><span class="line">        product.setTitle(<span class="string">"小米 2 手机"</span>);</span><br><span class="line">        product.setCategory(<span class="string">"手机"</span>);</span><br><span class="line">        product.setPrice(<span class="number">9999.0</span>);</span><br><span class="line">        product.setImages(<span class="string">"http://www.atguigu/xm.jpg"</span>);</span><br><span class="line">        productDao.save(product);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//POSTMAN, GET http://localhost:9200/product/_doc/2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据 id 查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findById</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Product product = productDao.findById(<span class="number">2L</span>).get();</span><br><span class="line">        System.out.println(product);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findAll</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Iterable&lt;Product&gt; products = productDao.findAll();</span><br><span class="line">        <span class="keyword">for</span> (Product product : products) &#123;</span><br><span class="line">            System.out.println(product);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Product product = <span class="keyword">new</span> Product();</span><br><span class="line">        product.setId(<span class="number">2L</span>);</span><br><span class="line">        productDao.delete(product);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//POSTMAN, GET http://localhost:9200/product/_doc/2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//批量新增</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveAll</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;Product&gt; productList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            Product product = <span class="keyword">new</span> Product();</span><br><span class="line">            product.setId(Long.valueOf(i));</span><br><span class="line">            product.setTitle(<span class="string">"["</span>+i+<span class="string">"]小米手机"</span>);</span><br><span class="line">            product.setCategory(<span class="string">"手机"</span>);</span><br><span class="line">            product.setPrice(<span class="number">1999.0</span> + i);</span><br><span class="line">            product.setImages(<span class="string">"http://www.atguigu/xm.jpg"</span>);</span><br><span class="line">            productList.add(product);</span><br><span class="line">        &#125;</span><br><span class="line">        productDao.saveAll(productList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分页查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByPageable</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//设置排序(排序方式，正序还是倒序，排序的 id)</span></span><br><span class="line">        Sort sort = Sort.by(Sort.Direction.DESC,<span class="string">"id"</span>);</span><br><span class="line">        <span class="keyword">int</span> currentPage=<span class="number">0</span>;<span class="comment">//当前页，第一页从 0 开始， 1 表示第二页</span></span><br><span class="line">        <span class="keyword">int</span> pageSize = <span class="number">5</span>;<span class="comment">//每页显示多少条</span></span><br><span class="line">        <span class="comment">//设置查询分页</span></span><br><span class="line">        PageRequest pageRequest = PageRequest.of(currentPage, pageSize,sort);</span><br><span class="line">        <span class="comment">//分页查询</span></span><br><span class="line">        Page&lt;Product&gt; productPage = productDao.findAll(pageRequest);</span><br><span class="line">        <span class="keyword">for</span> (Product Product : productPage.getContent()) &#123;</span><br><span class="line">            System.out.println(Product);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="框架集成-SpringData-集成测试-文档搜索"><a href="#框架集成-SpringData-集成测试-文档搜索" class="headerlink" title="框架集成-SpringData-集成测试-文档搜索"></a>框架集成-SpringData-集成测试-文档搜索</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.lun.dao.ProductDao;</span><br><span class="line"><span class="keyword">import</span> com.lun.model.Product;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.TermQueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.PageRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">SpringDataESSearchTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductDao productDao;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * term 查询</span></span><br><span class="line"><span class="comment">     * search(termQueryBuilder) 调用搜索方法，参数查询构建器对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">termQuery</span><span class="params">()</span></span>&#123;</span><br><span class="line">        TermQueryBuilder termQueryBuilder = QueryBuilders.termQuery(<span class="string">"title"</span>, <span class="string">"小米"</span>);</span><br><span class="line">                Iterable&lt;Product&gt; products = productDao.search(termQueryBuilder);</span><br><span class="line">        <span class="keyword">for</span> (Product product : products) &#123;</span><br><span class="line">            System.out.println(product);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * term 查询加分页</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">termQueryByPage</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> currentPage= <span class="number">0</span> ;</span><br><span class="line">        <span class="keyword">int</span> pageSize = <span class="number">5</span>;</span><br><span class="line">        <span class="comment">//设置查询分页</span></span><br><span class="line">        PageRequest pageRequest = PageRequest.of(currentPage, pageSize);</span><br><span class="line">        TermQueryBuilder termQueryBuilder = QueryBuilders.termQuery(<span class="string">"title"</span>, <span class="string">"小米"</span>);</span><br><span class="line">                Iterable&lt;Product&gt; products =</span><br><span class="line">                        productDao.search(termQueryBuilder,pageRequest);</span><br><span class="line">        <span class="keyword">for</span> (Product product : products) &#123;</span><br><span class="line">            System.out.println(product);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="面试题"><a href="#面试题" class="headerlink" title="面试题"></a>面试题</h1><h2 id="为什么要使用-Elasticsearch？"><a href="#为什么要使用-Elasticsearch？" class="headerlink" title="为什么要使用 Elasticsearch？"></a>为什么要使用 Elasticsearch？</h2><p>系统中的数据， 随着业务的发展，时间的推移， 将会非常多， 而业务中往往采用模糊查询进行数据的搜索， 而模糊查询会导致查询引擎放弃索引，导致系统查询数据时都是全表扫描，在百万级别的数据库中，查询效率是非常低下的，而我们使用 ES 做一个全文索引，将经常查询的系统功能的某些字段，比如说电商系统的商品表中商品名，描述、价格还有 id 这些字段我们放入 ES 索引库里，可以提高查询速度。</p>
<h2 id="Elasticsearch-的-master-选举流程？"><a href="#Elasticsearch-的-master-选举流程？" class="headerlink" title="Elasticsearch 的 master 选举流程？"></a>Elasticsearch 的 master 选举流程？</h2><ul>
<li>Elasticsearch的选主是ZenDiscovery模块负责的，主要包含Ping（节点之间通过这个RPC来发现彼此）<br>和Unicast（单播模块包含-一个主机列表以控制哪些节点需要ping通）这两部分。</li>
<li>对所有可以成为master的节点（node master: true）根据nodeId字典排序，每次选举每个节点都把自<br>己所知道节点排一次序，然后选出第一个（第0位）节点，暂且认为它是master节点。</li>
<li>如果对某个节点的投票数达到一定的值（可以成为master节点数n/2+1）并且该节点自己也选举自己，<br>那这个节点就是master。否则重新选举一直到满足上述条件。</li>
<li>master节点的职责主要包括集群、节点和索引的管理，不负责文档级别的管理；data节点可以关闭http<br>功能。</li>
</ul>
<h2 id="Elasticsearch-集群脑裂问题？"><a href="#Elasticsearch-集群脑裂问题？" class="headerlink" title="Elasticsearch 集群脑裂问题？"></a>Elasticsearch 集群脑裂问题？</h2><p>“脑裂”问题可能的成因：</p>
<ul>
<li>网络问题：集群间的网络延迟导致一些节点访问不到master, 认为master 挂掉了从而选举出新的master,并对master上的分片和副本标红，分配新的主分片。</li>
<li>节点负载：主节点的角色既为master又为data,访问量较大时可能会导致ES停止响应造成大面积延迟，此时其他节点得不到主节点的响应认为主节点挂掉了，会重新选取主节点。</li>
<li>内存回收：data 节点上的ES进程占用的内存较大，引发JVM的大规模内存回收，造成ES进程失去响应。</li>
</ul>
<p>脑裂问题解决方案：</p>
<ul>
<li><p>减少误判：discovery.zen ping_ timeout 节点状态的响应时间，默认为3s，可以适当调大，如果master在该响应时间的范围内没有做出响应应答，判断该节点已经挂掉了。调大参数（如6s，discovery.zen.ping_timeout:6），可适当减少误判。</p>
</li>
<li><p>选举触发：discovery.zen.minimum. <em>master</em> nodes:1，该参數是用于控制选举行为发生的最小集群主节点数量。当备选主节点的个數大于等于该参数的值，且备选主节点中有该参数个节点认为主节点挂了，进行选举。官方建议为(n / 2) +1, n为主节点个数（即有资格成为主节点的节点个数）。</p>
</li>
<li><p>角色分离：即master节点与data节点分离，限制角色</p>
<ul>
<li>主节点配置为：node master: true，node data: false</li>
<li>从节点配置为：node master: false，node data: true</li>
</ul>
</li>
</ul>
<h2 id="Elasticsearch-索引文档的流程？"><a href="#Elasticsearch-索引文档的流程？" class="headerlink" title="Elasticsearch 索引文档的流程？"></a>Elasticsearch 索引文档的流程？</h2><p>![Elasticsearch 索引文档的流程.png](/images/database/es/Elasticsearch 索引文档的流程.png)</p>
<ul>
<li>协调节点默认使用文档 ID 参与计算（也支持通过 routing），以便为路由提供合适的分片：shard = hash(document_id) % (num_of_primary_shards)</li>
<li>当分片所在的节点接收到来自协调节点的请求后，会将请求写入到 Memory Buffer，然后定时（默认是每隔 1 秒）写入到 Filesystem Cache，这个从 Memory Buffer 到 Filesystem Cache 的过程就叫做 refresh；</li>
<li>当然在某些情况下，存在 Momery Buffer 和 Filesystem Cache 的数据可能会丢失， ES 是通过 translog的机制来保证数据的可靠性的。其实现机制是接收到请求后，同时也会写入到 translog 中，当 Filesystemcache 中的数据写入到磁盘中时，才会清除掉，这个过程叫做 flush；</li>
<li>在 flush 过程中，内存中的缓冲将被清除，内容被写入一个新段，段的 fsync 将创建一个新的提交点，并将内容刷新到磁盘，旧的 translog 将被删除并开始一个新的 translog。</li>
<li>flush 触发的时机是定时触发（默认 30 分钟）或者 translog 变得太大（默认为 512M）时；</li>
</ul>
<h2 id="Elasticsearch-更新和删除文档的流程？"><a href="#Elasticsearch-更新和删除文档的流程？" class="headerlink" title="Elasticsearch 更新和删除文档的流程？"></a>Elasticsearch 更新和删除文档的流程？</h2><ul>
<li>删除和更新也都是写操作，但是 Elasticsearch 中的文档是不可变的，因此不能被删除或者改动以展示其变更；</li>
<li>磁盘上的每个段都有一个相应的.del 文件。当删除请求发送后，文档并没有真的被删除，而是在.del文件中被标记为删除。该文档依然能匹配查询，但是会在结果中被过滤掉。当段合并时，在.del 文件中被标记为删除的文档将不会被写入新段。</li>
<li>在新的文档被创建时， Elasticsearch 会为该文档指定一个版本号，当执行更新时，旧版本的文档在.del文件中被标记为删除，新版本的文档被索引到一个新段。旧版本的文档依然能匹配查询，但是会在结果中被过滤掉。</li>
</ul>
<h2 id="Elasticsearch-搜索的流程？"><a href="#Elasticsearch-搜索的流程？" class="headerlink" title="Elasticsearch 搜索的流程？"></a>Elasticsearch 搜索的流程？</h2><p>![Elasticsearch 搜索的流程.png](/images/database/es/Elasticsearch 搜索的流程.png)</p>
<ul>
<li>搜索被执行成一个两阶段过程，我们称之为 Query Then Fetch；</li>
<li>在初始查询阶段时，查询会广播到索引中每一个分片拷贝（主分片或者副本分片）。 每个分片在本地执行搜索并构建一个匹配文档的大小为 from + size 的优先队列。 PS：在搜索的时候是会查询Filesystem Cache 的，但是有部分数据还在 Memory Buffer，所以搜索是近实时的。</li>
<li>每个分片返回各自优先队列中 所有文档的 ID 和排序值 给协调节点，它合并这些值到自己的优先队列中来产生一个全局排序后的结果列表。</li>
<li>接下来就是取回阶段， 协调节点辨别出哪些文档需要被取回并向相关的分片提交多个 GET 请求。每个分片加载并丰富文档，如果有需要的话，接着返回文档给协调节点。一旦所有的文档都被取回了，协调节点返回结果给客户端。</li>
<li>Query Then Fetch 的搜索类型在文档相关性打分的时候参考的是本分片的数据，这样在文档数量较少的时候可能不够准确， DFS Query Then Fetch 增加了一个预查询的处理，询问 Term 和 Document frequency，这个评分更准确，但是性能会变差。</li>
</ul>
<h2 id="Elasticsearch-在部署时，对-Linux-的设置有哪些优化方法？"><a href="#Elasticsearch-在部署时，对-Linux-的设置有哪些优化方法？" class="headerlink" title="Elasticsearch 在部署时，对 Linux 的设置有哪些优化方法？"></a>Elasticsearch 在部署时，对 Linux 的设置有哪些优化方法？</h2><ul>
<li><p>64 GB 内存的机器是非常理想的， 但是 32 GB 和 16 GB 机器也是很常见的。少于 8 GB 会适得其反。</p>
</li>
<li><p>如果你要在更快的 CPUs 和更多的核心之间选择，选择更多的核心更好。多个内核提供的额外并发远胜过稍微快一点点的时钟频率。</p>
</li>
<li><p>如果你负担得起 SSD，它将远远超出任何旋转介质。 基于 SSD 的节点，查询和索引性能都有提升。如果你负担得起， SSD 是一个好的选择。</p>
</li>
<li><p>即使数据中心们近在咫尺，也要避免集群跨越多个数据中心。绝对要避免集群跨越大的地理距离。</p>
</li>
<li><p>请确保运行你应用程序的 JVM 和服务器的 JVM 是完全一样的。 在 Elasticsearch 的几个地方，使用 Java 的本地序列化。</p>
</li>
<li><p>通过设置 gateway.recover_after_nodes、 gateway.expected_nodes、 gateway.recover_after_time 可以在集群重启的时候避免过多的分片交换，这可能会让数据恢复从数个小时缩短为几秒钟。</p>
</li>
<li><p>Elasticsearch 默认被配置为使用单播发现，以防止节点无意中加入集群。只有在同一台机器上运行的节点才会自动组成集群。最好使用单播代替组播。</p>
</li>
<li><p>不要随意修改垃圾回收器（CMS）和各个线程池的大小。</p>
</li>
<li><p>把你的内存的（少于）一半给 Lucene（但不要超过 32 GB！），通过 ES_HEAP_SIZE 环境变量设置。</p>
</li>
<li><p>内存交换到磁盘对服务器性能来说是致命的。如果内存交换到磁盘上，一个 100 微秒的操作可能变成 10 毫秒。 再想想那么多 10 微秒的操作时延累加起来。 不难看出 swapping 对于性能是多么可怕。</p>
</li>
<li><p>Lucene 使用了大量的文件。同时， Elasticsearch 在节点和 HTTP 客户端之间进行通信也使用了大量的套接字。 所有这一切都需要足够的文件描述符。你应该增加你的文件描述符，设置一个很大的值，如 64,000。</p>
</li>
</ul>
<h2 id="GC-方面，在使用-Elasticsearch-时要注意什么？"><a href="#GC-方面，在使用-Elasticsearch-时要注意什么？" class="headerlink" title="GC 方面，在使用 Elasticsearch 时要注意什么？"></a>GC 方面，在使用 Elasticsearch 时要注意什么？</h2><p>倒排词典的索引需要常驻内存，无法 GC，需要监控 data node 上 segment memory 增长趋势。</p>
<p>各类缓存， field cache, filter cache, indexing cache, bulk queue 等等，要设置合理的大小，并且要应该根据最坏的情况来看 heap 是否够用，也就是各类缓存全部占满的时候，还有 heap 空间可以分配给其他任务吗？避免采用 clear cache 等“自欺欺人”的方式来释放内存。</p>
<p>避免返回大量结果集的搜索与聚合。确实需要大量拉取数据的场景，可以采用 scan &amp; scroll api 来实现。</p>
<p>cluster stats 驻留内存并无法水平扩展，超大规模集群可以考虑分拆成多个集群通过 tribe node 连接。</p>
<p>想知道 heap 够不够，必须结合实际应用场景，并对集群的 heap 使用情况做持续的监控。</p>
<h2 id="Elasticsearch-对于大数据量（上亿量级）的聚合如何实现？"><a href="#Elasticsearch-对于大数据量（上亿量级）的聚合如何实现？" class="headerlink" title="Elasticsearch 对于大数据量（上亿量级）的聚合如何实现？"></a>Elasticsearch 对于大数据量（上亿量级）的聚合如何实现？</h2><p>Elasticsearch 提供的首个近似聚合是 cardinality 度量。它提供一个字段的基数，即该字段的 distinct或者 unique 值的数目。它是基于 HLL 算法的。 HLL 会先对我们的输入作哈希运算，然后根据哈希运算的结果中的 bits 做概率估算从而得到基数。其特点是：可配置的精度，用来控制内存的使用（更精确 ＝ 更多内存）；小的数据集精度是非常高的；我们可以通过配置参数，来设置去重需要的固定内存使用量。无论数千还是数十亿的唯一值，内存使用量只与你配置的精确度相关。</p>
<h2 id="在并发情况下，-Elasticsearch-如果保证读写一致？"><a href="#在并发情况下，-Elasticsearch-如果保证读写一致？" class="headerlink" title="在并发情况下， Elasticsearch 如果保证读写一致？"></a>在并发情况下， Elasticsearch 如果保证读写一致？</h2><ul>
<li><p>可以通过版本号使用乐观并发控制，以确保新版本不会被旧版本覆盖，由应用层来处理具体的冲突；</p>
</li>
<li><p>另外对于写操作，一致性级别支持 quorum/one/all，默认为 quorum，即只有当大多数分片可用时才允许写操作。但即使大多数可用，也可能存在因为网络等原因导致写入副本失败，这样该副本被认为故障，分片将会在一个不同的节点上重建。</p>
</li>
<li><p>对于读操作，可以设置 replication 为 sync(默认)，这使得操作在主分片和副本分片都完成后才会返回；如果设置 replication 为 async 时，也可以通过设置搜索请求参数_preference 为 primary 来查询主分片，确保文档是最新版本。</p>
</li>
</ul>
<h2 id="如何监控-Elasticsearch-集群状态？"><a href="#如何监控-Elasticsearch-集群状态？" class="headerlink" title="如何监控 Elasticsearch 集群状态？"></a>如何监控 Elasticsearch 集群状态？</h2><ol>
<li>elasticsearch-head 插件。</li>
<li>通过 Kibana 监控 Elasticsearch。你可以实时查看你的集群健康状态和性能，也可以分析过去的集群、索引和节点指标</li>
</ol>
<h2 id="是否了解字典树？"><a href="#是否了解字典树？" class="headerlink" title="是否了解字典树？"></a>是否了解字典树？</h2><p>字典树又称单词查找树， Trie 树，是一种树形结构，是一种哈希树的变种。典型应用是用于统计，排序和保存大量的字符串（但不仅限于字符串），所以经常被搜索引擎系统用于文本词频统计。它的优点是：利用字符串的公共前缀来减少查询时间，最大限度地减少无谓的字符串比较，查询效率比哈希树高。</p>
<p>Trie 的核心思想是空间换时间，利用字符串的公共前缀来降低查询时间的开销以达到提高效率的目的。它有 3 个基本性质：</p>
<ul>
<li>根节点不包含字符，除根节点外每一个节点都只包含一个字符。</li>
<li>从根节点到某一节点，路径上经过的字符连接起来，为该节点对应的字符串。</li>
<li>每个节点的所有子节点包含的字符都不相同。</li>
</ul>
<p>对于中文的字典树，每个节点的子节点用一个哈希表存储，这样就不用浪费太大的空间，而且查询速度上可以保留哈希的复杂度 O(1)。</p>
<h2 id="Elasticsearch-中的集群、节点、索引、文档、类型是什么？"><a href="#Elasticsearch-中的集群、节点、索引、文档、类型是什么？" class="headerlink" title="Elasticsearch 中的集群、节点、索引、文档、类型是什么？"></a>Elasticsearch 中的集群、节点、索引、文档、类型是什么？</h2><ul>
<li>集群是一个或多个节点（服务器）的集合，它们共同保存您的整个数据，并提供跨所有节点的联合索引和搜索功能。群集由唯一名 称标识，默认情况下为”elasticsearch”。此名称很重要，因为如果节点设置为按名称加入群集，则该节点只能是群集的一部分。</li>
<li>节点是属于集群一部分的单个服务器。它存储数据并参与群集索引和搜索功能。</li>
<li>索引就像关系数据库中的“数据库”。它有一个定义多种类型的映射。索引是逻辑名称空间，映射到一个或多个主分片，并且可以有零个或多个副本分片。MySQL =&gt;数据库，Elasticsearch=&gt;索引。</li>
<li>文档类似于关系数据库中的一行。不同之处在于索引中的每个文档可以具有不同的结构(字段)，但是对于通用字段应该具有相同的数据类型。MySQL =&gt; Databases =&gt; Tables =&gt; Columns / Rows，Elasticsearch=&gt; Indices =&gt; Types =&gt;具有属性的文档Doc。</li>
<li>类型是索引的逻辑类别/分区，其语义完全取决于用户。</li>
</ul>
<h2 id="Elasticsearch-中的倒排索引是什么？"><a href="#Elasticsearch-中的倒排索引是什么？" class="headerlink" title="Elasticsearch 中的倒排索引是什么？"></a>Elasticsearch 中的倒排索引是什么？</h2><p>倒排索引是搜索引擎的核心。搜索引擎的主要目标是在查找发生搜索条件的文档时提供快速搜索。ES中的倒排索引其实就是 lucene 的倒排索引，区别于传统的正向索引， 倒排索引会再存储数据时将关键词和数据进行关联，保存到倒排表中，然后查询时，将查询内容进行分词后在倒排表中进行查询，最后匹配数据即可。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ES/" rel="tag"># ES</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/06/04/java/JVM-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E4%B8%8E%E8%B0%83%E4%BC%98/" rel="prev" title="JVM 学习笔记 - 性能监控与调优">
      <i class="fa fa-chevron-left"></i> JVM 学习笔记 - 性能监控与调优
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/06/10/database/redis/" rel="next" title="Redis">
      Redis <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#基本操作"><span class="nav-number">1.</span> <span class="nav-text">基本操作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装"><span class="nav-number">1.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据格式"><span class="nav-number">1.2.</span> <span class="nav-text">数据格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP-操作"><span class="nav-number">1.3.</span> <span class="nav-text">HTTP 操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#索引操作"><span class="nav-number">1.3.1.</span> <span class="nav-text">索引操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建索引"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">创建索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看所有索引"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">查看所有索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看单个索引"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">查看单个索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#删除索引"><span class="nav-number">1.3.1.4.</span> <span class="nav-text">删除索引</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文档操作"><span class="nav-number">1.3.2.</span> <span class="nav-text">文档操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建文档"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">创建文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看文档"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">查看文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改文档"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">修改文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改字段"><span class="nav-number">1.3.2.4.</span> <span class="nav-text">修改字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#删除文档"><span class="nav-number">1.3.2.5.</span> <span class="nav-text">删除文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#条件删除文档"><span class="nav-number">1.3.2.6.</span> <span class="nav-text">条件删除文档</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#映射操作"><span class="nav-number">1.3.3.</span> <span class="nav-text">映射操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建映射"><span class="nav-number">1.3.4.</span> <span class="nav-text">创建映射</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#查看映射"><span class="nav-number">1.3.4.1.</span> <span class="nav-text">查看映射</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#索引映射关联"><span class="nav-number">1.3.4.2.</span> <span class="nav-text">索引映射关联</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#高级查询"><span class="nav-number">1.3.5.</span> <span class="nav-text">高级查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#查询所有文档"><span class="nav-number">1.3.5.1.</span> <span class="nav-text">查询所有文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#匹配查询"><span class="nav-number">1.3.5.2.</span> <span class="nav-text">匹配查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#字段匹配查询"><span class="nav-number">1.3.5.3.</span> <span class="nav-text">字段匹配查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#关键字精确查询"><span class="nav-number">1.3.5.4.</span> <span class="nav-text">关键字精确查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多关键字精确查询"><span class="nav-number">1.3.5.5.</span> <span class="nav-text">多关键字精确查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#指定查询字段"><span class="nav-number">1.3.5.6.</span> <span class="nav-text">指定查询字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#过滤字段"><span class="nav-number">1.3.5.7.</span> <span class="nav-text">过滤字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#组合查询"><span class="nav-number">1.3.5.8.</span> <span class="nav-text">组合查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#范围查询"><span class="nav-number">1.3.5.9.</span> <span class="nav-text">范围查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#模糊查询"><span class="nav-number">1.3.5.10.</span> <span class="nav-text">模糊查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#单字段排序"><span class="nav-number">1.3.5.11.</span> <span class="nav-text">单字段排序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多字段排序"><span class="nav-number">1.3.5.12.</span> <span class="nav-text">多字段排序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#高亮查询"><span class="nav-number">1.3.5.13.</span> <span class="nav-text">高亮查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分页查询"><span class="nav-number">1.3.5.14.</span> <span class="nav-text">分页查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#聚合查询"><span class="nav-number">1.3.5.15.</span> <span class="nav-text">聚合查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#桶聚合查询"><span class="nav-number">1.3.5.16.</span> <span class="nav-text">桶聚合查询</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Java-API-操作"><span class="nav-number">1.4.</span> <span class="nav-text">Java API 操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建es客户端"><span class="nav-number">1.4.1.</span> <span class="nav-text">创建es客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#doc操作"><span class="nav-number">1.4.2.</span> <span class="nav-text">doc操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Index操作"><span class="nav-number">1.4.3.</span> <span class="nav-text">Index操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集群"><span class="nav-number">1.5.</span> <span class="nav-text">集群</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#进阶"><span class="nav-number">2.</span> <span class="nav-text">进阶</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#路由计算-amp-分片控制"><span class="nav-number">2.1.</span> <span class="nav-text">路由计算 &amp; 分片控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#分片控制"><span class="nav-number">2.1.1.</span> <span class="nav-text">分片控制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据写流程"><span class="nav-number">2.2.</span> <span class="nav-text">数据写流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据读流程"><span class="nav-number">2.3.</span> <span class="nav-text">数据读流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新流程-amp-批量操作流程"><span class="nav-number">2.4.</span> <span class="nav-text">更新流程 &amp; 批量操作流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#更新流程"><span class="nav-number">2.4.1.</span> <span class="nav-text">更新流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#批量操作流程"><span class="nav-number">2.4.2.</span> <span class="nav-text">批量操作流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#倒排索引"><span class="nav-number">2.5.</span> <span class="nav-text">倒排索引</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#倒排索引原理"><span class="nav-number">2.5.1.</span> <span class="nav-text">倒排索引原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#倒排索引的例子"><span class="nav-number">2.5.2.</span> <span class="nav-text">倒排索引的例子</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文档搜索"><span class="nav-number">2.6.</span> <span class="nav-text">文档搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#不可改变的倒排索引"><span class="nav-number">2.6.1.</span> <span class="nav-text">不可改变的倒排索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态更新索引"><span class="nav-number">2.6.2.</span> <span class="nav-text">动态更新索引</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文档刷新-amp-文档刷写-amp-文档合并"><span class="nav-number">2.7.</span> <span class="nav-text">文档刷新 &amp; 文档刷写 &amp; 文档合并</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#近实时搜索"><span class="nav-number">2.7.1.</span> <span class="nav-text">近实时搜索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#持久化变更"><span class="nav-number">2.7.2.</span> <span class="nav-text">持久化变更</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#段合并"><span class="nav-number">2.7.3.</span> <span class="nav-text">段合并</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文档分析"><span class="nav-number">2.8.</span> <span class="nav-text">文档分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文档控制"><span class="nav-number">2.9.</span> <span class="nav-text">文档控制</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SpringData集成"><span class="nav-number">3.</span> <span class="nav-text">SpringData集成</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#框架集成-SpringData-集成测试-索引操作"><span class="nav-number">3.1.</span> <span class="nav-text">框架集成-SpringData-集成测试-索引操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#框架集成-SpringData-集成测试-文档操作"><span class="nav-number">3.2.</span> <span class="nav-text">框架集成-SpringData-集成测试-文档操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#框架集成-SpringData-集成测试-文档搜索"><span class="nav-number">3.3.</span> <span class="nav-text">框架集成-SpringData-集成测试-文档搜索</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#面试题"><span class="nav-number">4.</span> <span class="nav-text">面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么要使用-Elasticsearch？"><span class="nav-number">4.1.</span> <span class="nav-text">为什么要使用 Elasticsearch？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-的-master-选举流程？"><span class="nav-number">4.2.</span> <span class="nav-text">Elasticsearch 的 master 选举流程？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-集群脑裂问题？"><span class="nav-number">4.3.</span> <span class="nav-text">Elasticsearch 集群脑裂问题？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-索引文档的流程？"><span class="nav-number">4.4.</span> <span class="nav-text">Elasticsearch 索引文档的流程？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-更新和删除文档的流程？"><span class="nav-number">4.5.</span> <span class="nav-text">Elasticsearch 更新和删除文档的流程？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-搜索的流程？"><span class="nav-number">4.6.</span> <span class="nav-text">Elasticsearch 搜索的流程？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-在部署时，对-Linux-的设置有哪些优化方法？"><span class="nav-number">4.7.</span> <span class="nav-text">Elasticsearch 在部署时，对 Linux 的设置有哪些优化方法？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GC-方面，在使用-Elasticsearch-时要注意什么？"><span class="nav-number">4.8.</span> <span class="nav-text">GC 方面，在使用 Elasticsearch 时要注意什么？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-对于大数据量（上亿量级）的聚合如何实现？"><span class="nav-number">4.9.</span> <span class="nav-text">Elasticsearch 对于大数据量（上亿量级）的聚合如何实现？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在并发情况下，-Elasticsearch-如果保证读写一致？"><span class="nav-number">4.10.</span> <span class="nav-text">在并发情况下， Elasticsearch 如果保证读写一致？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何监控-Elasticsearch-集群状态？"><span class="nav-number">4.11.</span> <span class="nav-text">如何监控 Elasticsearch 集群状态？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#是否了解字典树？"><span class="nav-number">4.12.</span> <span class="nav-text">是否了解字典树？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-中的集群、节点、索引、文档、类型是什么？"><span class="nav-number">4.13.</span> <span class="nav-text">Elasticsearch 中的集群、节点、索引、文档、类型是什么？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-中的倒排索引是什么？"><span class="nav-number">4.14.</span> <span class="nav-text">Elasticsearch 中的倒排索引是什么？</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Cai Kenny</p>
  <div class="site-description" itemprop="description">A Programmer</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">24</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cai Kenny</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.1
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.6.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
